"""0005_update_registering_name_in_view

Revision ID: 793f7c153047
Revises: c347f1fa6229
Create Date: 2025-12-19 12:16:12.954487

"""
from alembic import op
from alembic_utils.pg_view import PGView

# revision identifiers, used by Alembic.
revision = '793f7c153047'
down_revision = 'c347f1fa6229'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    public_account_draft_vw = PGView(
        schema="public",
        signature="account_draft_vw",
        definition="SELECT d.document_number,\n       d.create_ts,\n       d.registration_type,\n       d.registration_type_cl,\n       rt.registration_desc,\n       CASE WHEN d.registration_type_cl IN ('PPSALIEN', 'CROWNLIEN', 'MISCLIEN') THEN ''\n            ELSE d.registration_number END base_reg_num,\n       d.draft ->> 'type' AS draft_type,\n       CASE WHEN d.update_ts IS NOT NULL THEN d.update_ts ELSE d.create_ts END last_update_ts,\n       CASE WHEN d.registration_type_cl IN ('PPSALIEN', 'CROWNLIEN', 'MISCLIEN') THEN\n                 d.draft -> 'financingStatement' ->> 'clientReferenceId'\n            WHEN d.registration_type_cl = 'AMENDMENT' THEN d.draft -> 'amendmentStatement' ->> 'clientReferenceId'\n            WHEN d.registration_type_cl = 'CHANGE' THEN d.draft -> 'changeStatement' ->> 'clientReferenceId'\n            ELSE '' END client_reference_id,\n       CASE WHEN d.registration_type_cl IN ('PPSALIEN', 'CROWNLIEN', 'MISCLIEN') AND\n                 d.draft -> 'financingStatement' -> 'registeringParty' IS NOT NULL THEN\n                 CASE WHEN d.draft -> 'financingStatement' -> 'registeringParty' -> 'businessName' IS NOT NULL THEN\n                           d.draft -> 'financingStatement' -> 'registeringParty' ->> 'businessName'\n                      WHEN d.draft -> 'financingStatement' -> 'registeringParty' ->> 'personName' IS NOT NULL THEN\n                      concat(d.draft -> 'financingStatement' -> 'registeringParty' -> 'personName' ->> 'first', ' ',\n                             d.draft -> 'financingStatement' -> 'registeringParty' -> 'personName' ->> 'last')\n                 END\n            WHEN d.registration_type_cl = 'AMENDMENT' AND\n                 (d.draft -> 'amendmentStatement' -> 'registeringParty') IS NOT NULL THEN\n                 CASE WHEN d.draft -> 'amendmentStatement' -> 'registeringParty' -> 'businessName' IS NOT NULL THEN\n                           d.draft -> 'amendmentStatement' -> 'registeringParty' ->> 'businessName'\n                      WHEN d.draft -> 'amendmentStatement' -> 'registeringParty' -> 'personName' IS NOT NULL THEN\n                        concat(d.draft -> 'amendmentStatement' -> 'registeringParty' -> 'personName' ->> 'first', ' ',\n                               d.draft -> 'amendmentStatement' -> 'registeringParty' -> 'personName' ->> 'last')\n                 END\n            ELSE '' END registering_party,\n      CASE WHEN d.registration_type_cl IN ('PPSALIEN', 'CROWNLIEN', 'MISCLIEN') AND\n                 d.draft -> 'financingStatement' -> 'securedParties' IS NOT NULL THEN\n                (SELECT string_agg((CASE WHEN (sp -> 'businessName') IS NOT NULL THEN\n                                             (sp ->> 'businessName')\n                                         WHEN sp -> 'personName' IS NOT NULL THEN\n                                            concat((sp -> 'personName' ->> 'first'), ' ',\n                                                   (sp -> 'personName' ->> 'last'))\n                                         END),\n                                   ',')\n                   FROM json_array_elements(d.draft -> 'financingStatement' -> 'securedParties') sp)\n          WHEN d.registration_type_cl = 'AMENDMENT' AND\n                 d.draft -> 'amendmentStatement' -> 'securedParties' IS NOT NULL THEN\n                (SELECT string_agg((CASE WHEN (sp2 -> 'businessName') IS NOT NULL THEN\n                                             (sp2 ->> 'businessName')\n                                         WHEN sp2 -> 'personName' IS NOT NULL THEN\n                                            concat((sp2 -> 'personName' ->> 'first'), ' ',\n                                                   (sp2 -> 'personName' ->> 'last'))\n                                         END),\n                                   ',')\n                   FROM json_array_elements(d.draft -> 'amendmentStatement' -> 'securedParties') sp2)\n            ELSE ' ' END secured_party,\n       (SELECT CASE\n          WHEN d.user_id IS NULL OR d.user_id = '' THEN ''\n          ELSE COALESCE((\n               SELECT CONCAT_WS(' ', NULLIF(TRIM(u.firstname), ''), NULLIF(TRIM(u.lastname), ''))\n               FROM users u\n               WHERE u.username = d.user_id FETCH FIRST 1 ROWS ONLY\n          ), '') END) AS registering_name,\n       d.account_id,\n       d.id,\n       d.registration_number\n  FROM drafts d, registration_types rt\n WHERE d.registration_type = rt.registration_type"
    )
    op.replace_entity(public_account_draft_vw)

    public_account_registration_staff_vw = PGView(
        schema="public",
        signature="account_registration_staff_vw",
        definition="""WITH q AS (\n         SELECT (now() AT TIME ZONE \'utc\'::text) AS current_expire_ts\n        )\n SELECT r.registration_number,\n    r.registration_ts,\n    r.registration_type,\n    r.registration_type_cl,\n    r.account_id,\n    rt.registration_desc,\n    r.base_reg_number,\n    r.id AS registration_id,\n    fs.id AS financing_id,\n        CASE\n            WHEN (((fs.state_type)::text = \'ACT\'::text) AND (fs.expire_date IS NOT NULL) AND ((fs.expire_date AT TIME ZONE \'utc\'::text) < (now() AT TIME ZONE \'utc\'::text))) THEN \'HEX\'::character varying\n            ELSE fs.state_type\n        END AS state,\n        CASE\n            WHEN (fs.life = 99) THEN \'-99\'::integer\n            ELSE (EXTRACT(days FROM ((fs.expire_date AT TIME ZONE \'utc\'::text) - (q.current_expire_ts)::timestamp with time zone)))::integer\n        END AS expire_days,\n    ( SELECT max(r2_1.registration_ts) AS max\n           FROM registrations r2_1\n          WHERE (r2_1.financing_id = r.financing_id)) AS last_update_ts,\n    ( SELECT\n                CASE\n                    WHEN (p.business_name IS NOT NULL) THEN (p.business_name)::text\n                    WHEN (p.branch_id IS NOT NULL) THEN (( SELECT client_codes.name\n                       FROM client_codes\n                      WHERE (client_codes.id = p.branch_id)))::text\n                    WHEN (p.middle_initial IS NOT NULL) THEN (((((p.first_name)::text || \' \'::text) || (p.middle_initial)::text) || \' \'::text) || (p.last_name)::text)\n                    ELSE (((p.first_name)::text || \' \'::text) || (p.last_name)::text)\n                END AS "case"\n           FROM parties p\n          WHERE ((p.registration_id = r.id) AND ((p.party_type)::text = \'RG\'::text))) AS registering_party,\n    ( SELECT string_agg(\n                CASE\n                    WHEN (p.business_name IS NOT NULL) THEN (p.business_name)::text\n                    WHEN (p.branch_id IS NOT NULL) THEN (( SELECT client_codes.name\n                       FROM client_codes\n                      WHERE (client_codes.id = p.branch_id)))::text\n                    WHEN (p.middle_initial IS NOT NULL) THEN (((((p.first_name)::text || \' \'::text) || (p.middle_initial)::text) || \' \'::text) || (p.last_name)::text)\n                    ELSE (((p.first_name)::text || \' \'::text) || (p.last_name)::text)\n                END, \', \'::text) AS string_agg\n           FROM parties p\n          WHERE ((p.financing_id = fs.id) AND (p.registration_id_end IS NULL) AND ((p.party_type)::text = \'SP\'::text))) AS secured_party,\n    r.client_reference_id,\n    (SELECT CASE\n            WHEN r.user_id IS NULL OR r.user_id = '' THEN ''\n            ELSE COALESCE((\n              SELECT CONCAT_WS(' ', NULLIF(TRIM(u.firstname), ''), NULLIF(TRIM(u.lastname), ''))\n              FROM users u\n              WHERE u.username = r.user_id FETCH FIRST 1 ROWS ONLY\n            ), '') END) AS registering_name,\n    r.account_id AS orig_account_id,\n    r2.account_id AS base_account_id,\n    ( SELECT count(vr.id) AS count\n           FROM verification_reports vr\n          WHERE ((vr.registration_id = r.id) AND (vr.doc_storage_url IS NULL))) AS pending_count,\n    ( SELECT count(sc.id) AS count\n           FROM serial_collateral sc\n          WHERE ((sc.financing_id = fs.id) AND ((sc.registration_id = r.id) OR ((sc.registration_id <= r.id) AND ((sc.registration_id_end IS NULL) OR (sc.registration_id_end > r.id)))))) AS vehicle_count\n   FROM registrations r,\n    registration_types rt,\n    financing_statements fs,\n    registrations r2,\n    q\n  WHERE (((r.registration_type)::text = (rt.registration_type)::text) AND (fs.id = r.financing_id) AND (NOT (EXISTS ( SELECT r2_1.financing_id\n           FROM user_extra_registrations uer,\n            registrations r2_1\n          WHERE (((uer.registration_number)::text = (r2_1.registration_number)::text) AND (r2_1.financing_id = r.financing_id) AND ((uer.removed_ind)::text = \'Y\'::text))))) AND (r2.financing_id = fs.id) AND (r2.financing_id = r.financing_id) AND ((r2.registration_type_cl)::text = ANY (ARRAY[(\'CROWNLIEN\'::character varying)::text, (\'MISCLIEN\'::character varying)::text, (\'PPSALIEN\'::character varying)::text])))\nUNION\n SELECT r.registration_number,\n    r.registration_ts,\n    r.registration_type,\n    r.registration_type_cl,\n    uer.account_id,\n    rt.registration_desc,\n    r.base_reg_number,\n    r.id AS registration_id,\n    fs.id AS financing_id,\n        CASE\n            WHEN (((fs.state_type)::text = \'ACT\'::text) AND (fs.expire_date IS NOT NULL) AND ((fs.expire_date AT TIME ZONE \'utc\'::text) < (now() AT TIME ZONE \'utc\'::text))) THEN \'HEX\'::character varying\n            ELSE fs.state_type\n        END AS state,\n        CASE\n            WHEN (fs.life = 99) THEN \'-99\'::integer\n            ELSE (EXTRACT(days FROM ((fs.expire_date AT TIME ZONE \'utc\'::text) - (q.current_expire_ts)::timestamp with time zone)))::integer\n        END AS expire_days,\n    ( SELECT max(r2_1.registration_ts) AS max\n           FROM registrations r2_1\n          WHERE (r2_1.financing_id = r.financing_id)) AS last_update_ts,\n    ( SELECT\n                CASE\n                    WHEN (p.business_name IS NOT NULL) THEN (p.business_name)::text\n                    WHEN (p.branch_id IS NOT NULL) THEN (( SELECT client_codes.name\n                       FROM client_codes\n                      WHERE (client_codes.id = p.branch_id)))::text\n                    WHEN (p.middle_initial IS NOT NULL) THEN (((((p.first_name)::text || \' \'::text) || (p.middle_initial)::text) || \' \'::text) || (p.last_name)::text)\n                    ELSE (((p.first_name)::text || \' \'::text) || (p.last_name)::text)\n                END AS "case"\n           FROM parties p\n          WHERE ((p.registration_id = r.id) AND ((p.party_type)::text = \'RG\'::text))) AS registering_party,\n    ( SELECT string_agg(\n                CASE\n                    WHEN (p.business_name IS NOT NULL) THEN (p.business_name)::text\n                    WHEN (p.branch_id IS NOT NULL) THEN (( SELECT client_codes.name\n                       FROM client_codes\n                      WHERE (client_codes.id = p.branch_id)))::text\n                    WHEN (p.middle_initial IS NOT NULL) THEN (((((p.first_name)::text || \' \'::text) || (p.middle_initial)::text) || \' \'::text) || (p.last_name)::text)\n                    ELSE (((p.first_name)::text || \' \'::text) || (p.last_name)::text)\n                END, \', \'::text) AS string_agg\n           FROM parties p\n          WHERE ((p.financing_id = fs.id) AND (p.registration_id_end IS NULL) AND ((p.party_type)::text = \'SP\'::text))) AS secured_party,\n    r.client_reference_id,\n    (SELECT CASE\n            WHEN r.user_id IS NULL OR r.user_id = '' THEN ''\n            ELSE COALESCE((\n              SELECT CONCAT_WS(' ', NULLIF(TRIM(u.firstname), ''), NULLIF(TRIM(u.lastname), ''))\n              FROM users u\n              WHERE u.username = r.user_id FETCH FIRST 1 ROWS ONLY\n            ), '') END) AS registering_name,\n    r.account_id AS orig_account_id,\n    r2.account_id AS base_account_id,\n    ( SELECT count(vr.id) AS count\n           FROM verification_reports vr\n          WHERE ((vr.registration_id = r.id) AND (vr.doc_storage_url IS NULL))) AS pending_count,\n    ( SELECT count(sc.id) AS count\n           FROM serial_collateral sc\n          WHERE ((sc.financing_id = fs.id) AND ((sc.registration_id = r.id) OR ((sc.registration_id <= r.id) AND ((sc.registration_id_end IS NULL) OR (sc.registration_id_end > r.id)))))) AS vehicle_count\n   FROM registrations r,\n    registration_types rt,\n    financing_statements fs,\n    user_extra_registrations uer,\n    registrations r2,\n    q\n  WHERE (((r.registration_type)::text = (rt.registration_type)::text) AND (fs.id = r.financing_id) AND (((r.registration_number)::text = (uer.registration_number)::text) OR ((r.base_reg_number)::text = (uer.registration_number)::text)) AND (uer.removed_ind IS NULL) AND (r2.financing_id = fs.id) AND (r2.financing_id = r.financing_id) AND ((r2.registration_type_cl)::text = ANY (ARRAY[(\'CROWNLIEN\'::character varying)::text, (\'MISCLIEN\'::character varying)::text, (\'PPSALIEN\'::character varying)::text])))"""
    )
    op.replace_entity(public_account_registration_staff_vw)

    public_account_registration_vw = PGView(
        schema="public",
        signature="account_registration_vw",
        definition="WITH q AS (\n  SELECT (now() at time zone 'utc')\n      AS current_expire_ts\n)\nSELECT r.registration_number, r.registration_ts, r.registration_type, r.registration_type_cl, r.account_id,\n       rt.registration_desc, r.base_reg_number, r.id AS registration_id, fs.id AS financing_id,\n       CASE WHEN fs.state_type = 'ACT' AND fs.expire_date IS NOT NULL AND\n                 (fs.expire_date at time zone 'utc') < (now() at time zone 'utc') THEN 'HEX'\n            ELSE fs.state_type END AS state,\n       CASE WHEN fs.life = 99 THEN -99\n            ELSE CAST(EXTRACT(days from (fs.expire_date at time zone 'utc' - current_expire_ts)) AS INT) END expire_days,\n       (SELECT MAX(r2.registration_ts)\n          FROM registrations r2\n         WHERE r2.financing_id = r.financing_id) AS last_update_ts,\n       (SELECT CASE WHEN p.business_name IS NOT NULL THEN p.business_name\n                    WHEN p.branch_id IS NOT NULL THEN (SELECT name FROM client_codes WHERE id = p.branch_id)\n                    WHEN p.middle_initial IS NOT NULL THEN p.first_name || ' ' || p.middle_initial || ' ' || p.last_name\n                    ELSE p.first_name || ' ' || p.last_name END\n          FROM parties p\n         WHERE p.registration_id = r.id\n           AND p.party_type = 'RG') AS registering_party,\n       (SELECT string_agg((CASE WHEN p.business_name IS NOT NULL THEN p.business_name\n                                WHEN p.branch_id IS NOT NULL THEN (SELECT name FROM client_codes WHERE id = p.branch_id)\n                                WHEN p.middle_initial IS NOT NULL THEN p.first_name || ' ' || p.middle_initial || ' ' || p.last_name\n                                ELSE p.first_name || ' ' || p.last_name END), ', ')\n          FROM parties p\n         WHERE p.financing_id = fs.id\n           AND p.registration_id_end IS NULL\n           AND p.party_type = 'SP') AS secured_party,\n       r.client_reference_id,\n       (SELECT CASE\n          WHEN r.user_id IS NULL OR r.user_id = '' THEN ''\n          ELSE COALESCE((\n            SELECT CONCAT_WS(' ', NULLIF(TRIM(u.firstname), ''), NULLIF(TRIM(u.lastname), ''))\n            FROM users u\n            WHERE u.username = r.user_id FETCH FIRST 1 ROWS ONLY\n          ), '') END) AS registering_name,\n       r.account_id AS orig_account_id,\n       r2.account_id AS base_account_id,\n       (SELECT COUNT(vr.id)\n          FROM verification_reports vr\n         WHERE vr.registration_id = r.id\n           AND vr.doc_storage_url IS NULL) AS pending_count,\n       (SELECT COUNT(sc.id)\n         FROM serial_collateral sc\n        WHERE sc.financing_id = fs.id\n          AND (sc.registration_id = r.id OR \n               (sc.registration_id <= r.id AND (sc.registration_id_end IS NULL OR sc.registration_id_end > r.id)))) AS vehicle_count \n FROM registrations r, registration_types rt, financing_statements fs, registrations r2, q\n WHERE r.registration_type = rt.registration_type\n   AND fs.id = r.financing_id\n   AND (fs.expire_date IS NULL OR (fs.expire_date at time zone 'utc') > ((now() at time zone 'utc') - interval '30 days'))\n   AND NOT EXISTS (SELECT r3.id\n                     FROM registrations r3\n                    WHERE r3.financing_id = fs.id\n                      AND r3.registration_type_cl = 'DISCHARGE'\n                      AND r3.registration_ts < ((now() at time zone 'utc') - interval '30 days'))\n  AND NOT EXISTS (SELECT r2.financing_id\n                    FROM user_extra_registrations uer, registrations r2\n                   WHERE uer.registration_number = r2.registration_number\n                     AND r2.financing_id = r.financing_id\n                     AND uer.removed_ind = 'Y')\n  AND r2.financing_id = fs.id\n  AND r2.financing_id = r.financing_id\n  AND r2.registration_type_cl IN ('CROWNLIEN', 'MISCLIEN', 'PPSALIEN')\nUNION (\nSELECT r.registration_number, r.registration_ts, r.registration_type, r.registration_type_cl, uer.account_id,\n       rt.registration_desc, r.base_reg_number, r.id AS registration_id, fs.id AS financing_id,\n       CASE WHEN fs.state_type = 'ACT' AND fs.expire_date IS NOT NULL AND\n                 (fs.expire_date at time zone 'utc') < (now() at time zone 'utc') THEN 'HEX'\n            ELSE fs.state_type END AS state,\n       CASE WHEN fs.life = 99 THEN -99\n            ELSE CAST(EXTRACT(days from (fs.expire_date at time zone 'utc' - current_expire_ts)) AS INT) END expire_days,\n       (SELECT MAX(r2.registration_ts)\n          FROM registrations r2\n         WHERE r2.financing_id = r.financing_id) AS last_update_ts,\n       (SELECT CASE WHEN p.business_name IS NOT NULL THEN p.business_name\n                    WHEN p.branch_id IS NOT NULL THEN (SELECT name FROM client_codes WHERE id = p.branch_id)\n                    WHEN p.middle_initial IS NOT NULL THEN p.first_name || ' ' || p.middle_initial || ' ' || p.last_name\n                    ELSE p.first_name || ' ' || p.last_name END\n          FROM parties p\n         WHERE p.registration_id = r.id\n           AND p.party_type = 'RG') AS registering_party,\n       (SELECT string_agg((CASE WHEN p.business_name IS NOT NULL THEN p.business_name\n                                WHEN p.branch_id IS NOT NULL THEN (SELECT name FROM client_codes WHERE id = p.branch_id)\n                                WHEN p.middle_initial IS NOT NULL THEN p.first_name || ' ' || p.middle_initial || ' ' || p.last_name\n                                ELSE p.first_name || ' ' || p.last_name END), ', ')\n          FROM parties p\n         WHERE p.financing_id = fs.id\n           AND p.registration_id_end IS NULL\n           AND p.party_type = 'SP') AS secured_party,\n       r.client_reference_id,\n       (SELECT CASE\n          WHEN r.user_id IS NULL OR r.user_id = '' THEN ''\n          ELSE COALESCE((\n            SELECT CONCAT_WS(' ', NULLIF(TRIM(u.firstname), ''), NULLIF(TRIM(u.lastname), ''))\n            FROM users u\n            WHERE u.username = r.user_id FETCH FIRST 1 ROWS ONLY\n          ), '') END) AS registering_name,\n       r.account_id AS orig_account_id,\n       r2.account_id AS base_account_id,\n       (SELECT COUNT(vr.id)\n          FROM verification_reports vr\n         WHERE vr.registration_id = r.id\n           AND vr.doc_storage_url IS NULL) AS pending_count,\n       (SELECT COUNT(sc.id)\n         FROM serial_collateral sc\n        WHERE sc.financing_id = fs.id\n          AND (sc.registration_id = r.id OR \n               (sc.registration_id <= r.id AND (sc.registration_id_end IS NULL OR sc.registration_id_end > r.id)))) AS vehicle_count \n  FROM registrations r, registration_types rt, financing_statements fs, user_extra_registrations uer, registrations r2, q\n WHERE r.registration_type = rt.registration_type\n   AND fs.id = r.financing_id\n   AND (fs.expire_date IS NULL OR (fs.expire_date at time zone 'utc') > ((now() at time zone 'utc') - interval '30 days'))\n   AND (r.registration_number = uer.registration_number OR r.base_reg_number = uer.registration_number)\n   AND uer.removed_ind IS NULL\n   AND NOT EXISTS (SELECT r3.id\n                     FROM registrations r3\n                    WHERE r3.financing_id = fs.id\n                      AND r3.registration_type_cl = 'DISCHARGE'\n                      AND r3.registration_ts < ((now() at time zone 'utc') - interval '30 days'))\n  AND r2.financing_id = fs.id\n  AND r2.financing_id = r.financing_id\n  AND r2.registration_type_cl IN ('CROWNLIEN', 'MISCLIEN', 'PPSALIEN')\n)"
    )
    op.replace_entity(public_account_registration_vw)

    public_mhr_account_reg_vw = PGView(
        schema="public",
        signature="mhr_account_reg_vw",
        definition="SELECT r.mhr_number, r.status_type, r.registration_ts,\n        (SELECT CASE WHEN p.business_name IS NOT NULL THEN p.business_name\n                      WHEN p.middle_name IS NOT NULL THEN p.first_name || ' ' || p.middle_name || ' ' || p.last_name\n                      ELSE p.first_name || ' ' || p.last_name\n                END\n            FROM mhr_parties p\n          WHERE p.registration_id = r.id \n            AND p.party_type = 'SUBMITTING') AS submitting_name,\n        r.client_reference_id,\n        r.registration_type,       \n        (SELECT string_agg((CASE WHEN p.business_name IS NOT NULL THEN p.business_name\n                                 WHEN p.suffix IS NOT NULL AND p.party_type = 'OWNER_IND' AND p.middle_name IS NOT NULL THEN p.first_name || ' ' || p.middle_name || ' ' || p.last_name || ' ' || p.suffix\n                                 WHEN p.suffix IS NOT NULL AND p.party_type = 'OWNER_IND' THEN p.first_name || ' ' || p.last_name || ' ' || p.suffix\n                                 WHEN p.middle_name IS NOT NULL THEN p.first_name || ' ' || p.middle_name || ' ' || p.last_name\n                                 ELSE p.first_name || ' ' || p.last_name END), '\\n')\n            FROM mhr_registrations r1, mhr_owner_groups og, mhr_parties p\n          WHERE r1.mhr_number = r.mhr_number \n            AND r1.id = og.registration_id\n            AND og.registration_id = p.registration_id\n            AND og.id = p.owner_group_id\n            AND r1.registration_ts = (SELECT MAX(r2.registration_ts)\n                                        FROM mhr_registrations r2, mhr_owner_groups og2\n                                        WHERE r2.mhr_number = r.mhr_number\n                                          AND og2.registration_id = r2.id\n                                          AND r2.id <= r.id)) AS owner_names,       \n        (SELECT CASE\n            WHEN r.user_id IS NULL OR r.user_id = '' THEN ''\n            ELSE COALESCE((\n              SELECT CONCAT_WS(' ', NULLIF(TRIM(u.firstname), ''), NULLIF(TRIM(u.lastname), ''))\n              FROM users u\n              WHERE u.username = r.user_id FETCH FIRST 1 ROWS ONLY\n            ), '') END) AS registering_name,\n        d.document_id,\n        d.document_registration_number,\n        (SELECT d2.document_type\n            FROM mhr_documents d2\n          WHERE d2.id = (SELECT d3.id\n                           FROM mhr_documents d3, mhr_registrations r2\n                          WHERE r2.id = d3.registration_id\n                            AND r2.mhr_number = r.mhr_number\n                          ORDER BY r2.registration_ts DESC\n                        FETCH FIRST 1 ROWS ONLY)) AS last_doc_type,\n        (SELECT n.status_type\n            FROM mhr_notes n\n          WHERE n.registration_id = r.id) AS note_status,\n        (SELECT n.expiry_date\n            FROM mhr_notes n\n          WHERE n.registration_id = r.id) AS note_expiry,\n        (CASE\n            WHEN d.document_type in ('NCAN', 'NRED') THEN\n              (SELECT n.document_type\n                FROM mhr_notes n\n                WHERE n.status_type != 'ACTIVE'\n                  AND n.change_registration_id = r.id\n                  AND n.document_type != 'CAUC'\n                  AND n.document_type != 'CAUE'\n              FETCH FIRST 1 ROWS ONLY)\n            ELSE NULL\n          END) AS cancel_doc_type,\n        (SELECT n.document_type\n            FROM mhr_notes n, mhr_registrations r2\n          WHERE r2.mhr_number = r.mhr_number\n            AND r2.id = n.registration_id\n            AND n.status_type = 'ACTIVE'\n            AND n.document_type IN ('TAXN', 'NCON', 'REST')\n          FETCH FIRST 1 ROWS ONLY) AS frozen_doc_type,\n        r.account_id,\n        dt.document_type_desc,\n        (SELECT CASE WHEN r.registration_type NOT IN ('MHREG', 'MHREG_CONVERSION') THEN ''\n              ELSE (SELECT lcv.registration_type\n                      FROM mhr_lien_check_vw lcv\n                    WHERE lcv.mhr_number = r.mhr_number\n                  ORDER BY lcv.base_registration_ts\n                  FETCH FIRST 1 ROWS ONLY) END) AS ppr_lien_type,\n        d.document_type,\n        r.id AS registration_id,\n        (SELECT mrr.doc_storage_url\n            FROM mhr_registration_reports mrr\n          WHERE mrr.registration_id = r.id) AS doc_storage_url,\n        (SELECT l.location_type\n            FROM mhr_locations l, mhr_registrations r2\n          WHERE r2.mhr_number = r.mhr_number\n            AND r2.id = l.registration_id\n            AND l.status_type = 'ACTIVE') AS location_type,\n        d.affirm_by,\n        (SELECT COUNT(mrr.id)\n            FROM mhr_registration_reports mrr\n          WHERE mrr.registration_id = r.id) AS report_count,\n       de.manufacturer_name,\n       case when a.street_additional is not null then a.street || '|' || a.street_additional || '|' || a.city || ' ' || a.region || '|' || initcap(ct.country_desc)\n            else a.street || '|' || a.city || ' ' || a.region || '|' || initcap(ct.country_desc) end as civic_address\n    FROM mhr_registrations r, mhr_documents d, mhr_document_types dt, \n         mhr_registrations rl, mhr_registrations rd, mhr_descriptions de, mhr_locations l, addresses a, country_types ct\n  WHERE r.id = d.registration_id\n    AND d.document_type = dt.document_type\n    AND r.mhr_number = rl.mhr_number\n    AND r.mhr_number = rd.mhr_number\n     AND rl.id = l.registration_id\n     AND l.status_type = 'ACTIVE'\n     AND l.address_id = a.id\n     and a.country = ct.country_type\n     AND rd.id = de.registration_id\n     AND de.status_type = 'ACTIVE'"
    )
    op.replace_entity(public_mhr_account_reg_vw)
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    public_mhr_account_reg_vw = PGView(
        schema="public",
        signature="mhr_account_reg_vw",
        definition="SELECT r.mhr_number, r.status_type, r.registration_ts,\n        (SELECT CASE WHEN p.business_name IS NOT NULL THEN p.business_name WHEN p.suffix IS NOT NULL AND p.party_type = 'OWNER_IND' AND p.middle_name IS NOT NULL THEN p.first_name || ' ' || p.middle_name || ' ' || p.last_name || ' ' || p.suffix WHEN p.suffix IS NOT NULL AND p.party_type = 'OWNER_IND' THEN p.first_name || ' ' || p.last_name || ' ' || p.suffix\n                      WHEN p.middle_name IS NOT NULL THEN p.first_name || ' ' || p.middle_name || ' ' || p.last_name\n                      ELSE p.first_name || ' ' || p.last_name\n                END\n            FROM mhr_parties p\n          WHERE p.registration_id = r.id \n            AND p.party_type = 'SUBMITTING') AS submitting_name,\n        r.client_reference_id,\n        r.registration_type,       \n        (SELECT string_agg((CASE WHEN p.business_name IS NOT NULL THEN p.business_name\n                                  WHEN p.middle_name IS NOT NULL THEN p.first_name || ' ' || p.middle_name || ' ' || p.last_name\n                                  ELSE p.first_name || ' ' || p.last_name END), '\\n')\n            FROM mhr_registrations r1, mhr_owner_groups og, mhr_parties p\n          WHERE r1.mhr_number = r.mhr_number \n            AND r1.id = og.registration_id\n            AND og.registration_id = p.registration_id\n            AND og.id = p.owner_group_id\n            AND r1.registration_ts = (SELECT MAX(r2.registration_ts)\n                                        FROM mhr_registrations r2, mhr_owner_groups og2\n                                        WHERE r2.mhr_number = r.mhr_number\n                                          AND og2.registration_id = r2.id\n                                          AND r2.id <= r.id)) AS owner_names,       \n        (SELECT CASE WHEN r.user_id IS NULL THEN ''\n                      ELSE (SELECT CASE WHEN u.lastname = '' or u.lastname IS NULL THEN u.firstname ELSE u.firstname || ' ' || u.lastname END\n                              FROM users u\n                            WHERE u.username = r.user_id FETCH FIRST 1 ROWS ONLY) END) AS registering_name,\n        d.document_id,\n        d.document_registration_number,\n        (SELECT d2.document_type\n            FROM mhr_documents d2\n          WHERE d2.id = (SELECT MAX(d3.id)\n                            FROM mhr_documents d3, mhr_registrations r2\n                          WHERE r2.id = d3.registration_id\n                            AND r2.mhr_number = r.mhr_number)) AS last_doc_type,\n        (SELECT n.status_type\n            FROM mhr_notes n\n          WHERE n.registration_id = r.id) AS note_status,\n        (SELECT n.expiry_date\n            FROM mhr_notes n\n          WHERE n.registration_id = r.id) AS note_expiry,\n        (CASE\n            WHEN d.document_type in ('NCAN', 'NRED') THEN\n              (SELECT n.document_type\n                FROM mhr_notes n\n                WHERE n.status_type != 'ACTIVE'\n                  AND n.change_registration_id = r.id\n                  AND n.document_type != 'CAUC'\n                  AND n.document_type != 'CAUE'\n              FETCH FIRST 1 ROWS ONLY)\n            ELSE NULL\n          END) AS cancel_doc_type,\n        (SELECT n.document_type\n            FROM mhr_notes n, mhr_registrations r2\n          WHERE r2.mhr_number = r.mhr_number\n            AND r2.id = n.registration_id\n            AND n.status_type = 'ACTIVE'\n            AND (n.document_type IN ('TAXN', 'NCON', 'REST') OR \n                  (n.document_type IN ('REG_103', 'REG_103E') AND \n                  n.expiry_date IS NOT NULL AND n.expiry_date > (now() at time zone 'UTC')))\n          FETCH FIRST 1 ROWS ONLY) AS frozen_doc_type,\n        r.account_id,\n        dt.document_type_desc,\n        (SELECT CASE WHEN r.registration_type NOT IN ('MHREG', 'MHREG_CONVERSION') THEN ''\n              ELSE (SELECT lcv.registration_type\n                      FROM mhr_lien_check_vw lcv\n                    WHERE lcv.mhr_number = r.mhr_number\n                  ORDER BY lcv.base_registration_ts\n                  FETCH FIRST 1 ROWS ONLY) END) AS ppr_lien_type,\n        d.document_type,\n        r.id AS registration_id,\n        (SELECT mrr.doc_storage_url\n            FROM mhr_registration_reports mrr\n          WHERE mrr.registration_id = r.id) AS doc_storage_url,\n        (SELECT l.location_type\n            FROM mhr_locations l, mhr_registrations r2\n          WHERE r2.mhr_number = r.mhr_number\n            AND r2.id = l.registration_id\n            AND l.status_type = 'ACTIVE') AS location_type,\n        d.affirm_by,\n        (SELECT COUNT(mrr.id)\n            FROM mhr_registration_reports mrr\n          WHERE mrr.registration_id = r.id) AS report_count, de.manufacturer_name, case when a.street_additional is not null then a.street || '|' || a.street_additional || '|' || a.city || ' ' || a.region || '|' || initcap(ct.country_desc) else a.street || '|' || a.city || ' ' || a.region || '|' || initcap(ct.country_desc) end as civic_address FROM mhr_registrations r, mhr_documents d, mhr_document_types dt, mhr_registrations rl, mhr_registrations rd, mhr_descriptions de, mhr_locations l, addresses a, country_types ct WHERE r.id = d.registration_id AND d.document_type = dt.document_type AND r.mhr_number = rl.mhr_number AND r.mhr_number = rd.mhr_number AND rl.id = l.registration_id AND l.status_type = 'ACTIVE' AND l.address_id = a.id and a.country = ct.country_type AND rd.id = de.registration_id AND de.status_type = 'ACTIVE'"
    )
    op.replace_entity(public_mhr_account_reg_vw)

    public_account_registration_vw = PGView(
        schema="public",
        signature="account_registration_vw",
        definition='WITH q AS (\n         SELECT (now() AT TIME ZONE \'utc\'::text) AS current_expire_ts\n        )\n SELECT r.registration_number,\n    r.registration_ts,\n    r.registration_type,\n    r.registration_type_cl,\n    r.account_id,\n    rt.registration_desc,\n    r.base_reg_number,\n    r.id AS registration_id,\n    fs.id AS financing_id,\n        CASE\n            WHEN (((fs.state_type)::text = \'ACT\'::text) AND (fs.expire_date IS NOT NULL) AND ((fs.expire_date AT TIME ZONE \'utc\'::text) < (now() AT TIME ZONE \'utc\'::text))) THEN \'HEX\'::character varying\n            ELSE fs.state_type\n        END AS state,\n        CASE\n            WHEN (fs.life = 99) THEN \'-99\'::integer\n            ELSE (EXTRACT(days FROM ((fs.expire_date AT TIME ZONE \'utc\'::text) - (q.current_expire_ts)::timestamp with time zone)))::integer\n        END AS expire_days,\n    ( SELECT max(r2_1.registration_ts) AS max\n           FROM registrations r2_1\n          WHERE (r2_1.financing_id = r.financing_id)) AS last_update_ts,\n    ( SELECT\n                CASE\n                    WHEN (p.business_name IS NOT NULL) THEN (p.business_name)::text\n                    WHEN (p.branch_id IS NOT NULL) THEN (( SELECT client_codes.name\n                       FROM client_codes\n                      WHERE (client_codes.id = p.branch_id)))::text\n                    WHEN (p.middle_initial IS NOT NULL) THEN (((((p.first_name)::text || \' \'::text) || (p.middle_initial)::text) || \' \'::text) || (p.last_name)::text)\n                    ELSE (((p.first_name)::text || \' \'::text) || (p.last_name)::text)\n                END AS "case"\n           FROM parties p\n          WHERE ((p.registration_id = r.id) AND ((p.party_type)::text = \'RG\'::text))) AS registering_party,\n    ( SELECT string_agg(\n                CASE\n                    WHEN (p.business_name IS NOT NULL) THEN (p.business_name)::text\n                    WHEN (p.branch_id IS NOT NULL) THEN (( SELECT client_codes.name\n                       FROM client_codes\n                      WHERE (client_codes.id = p.branch_id)))::text\n                    WHEN (p.middle_initial IS NOT NULL) THEN (((((p.first_name)::text || \' \'::text) || (p.middle_initial)::text) || \' \'::text) || (p.last_name)::text)\n                    ELSE (((p.first_name)::text || \' \'::text) || (p.last_name)::text)\n                END, \', \'::text) AS string_agg\n           FROM parties p\n          WHERE ((p.financing_id = fs.id) AND (p.registration_id_end IS NULL) AND ((p.party_type)::text = \'SP\'::text))) AS secured_party,\n    r.client_reference_id,\n    ( SELECT\n                CASE\n                    WHEN (r.user_id IS NULL) THEN \'\'::text\n                    ELSE ( SELECT\n                            CASE\n                                WHEN (((u.lastname)::text = \'\'::text) OR (u.lastname IS NULL)) THEN (u.firstname)::text\n                                ELSE (((u.firstname)::text || \' \'::text) || (u.lastname)::text)\n                            END AS "case"\n                       FROM users u\n                      WHERE ((u.username)::text = (r.user_id)::text)\n                     LIMIT 1)\n                END AS "case") AS registering_name,\n    r.account_id AS orig_account_id,\n    r2.account_id AS base_account_id,\n    ( SELECT count(vr.id) AS count\n           FROM verification_reports vr\n          WHERE ((vr.registration_id = r.id) AND (vr.doc_storage_url IS NULL))) AS pending_count,\n    ( SELECT count(sc.id) AS count\n           FROM serial_collateral sc\n          WHERE ((sc.financing_id = fs.id) AND ((sc.registration_id = r.id) OR ((sc.registration_id <= r.id) AND ((sc.registration_id_end IS NULL) OR (sc.registration_id_end > r.id)))))) AS vehicle_count\n   FROM registrations r,\n    registration_types rt,\n    financing_statements fs,\n    registrations r2,\n    q\n  WHERE (((r.registration_type)::text = (rt.registration_type)::text) AND (fs.id = r.financing_id) AND ((fs.expire_date IS NULL) OR ((fs.expire_date AT TIME ZONE \'utc\'::text) > ((now() AT TIME ZONE \'utc\'::text) - \'30 days\'::interval))) AND (NOT (EXISTS ( SELECT r3.id\n           FROM registrations r3\n          WHERE ((r3.financing_id = fs.id) AND ((r3.registration_type_cl)::text = \'DISCHARGE\'::text) AND (r3.registration_ts < ((now() AT TIME ZONE \'utc\'::text) - \'30 days\'::interval)))))) AND (NOT (EXISTS ( SELECT r2_1.financing_id\n           FROM user_extra_registrations uer,\n            registrations r2_1\n          WHERE (((uer.registration_number)::text = (r2_1.registration_number)::text) AND (r2_1.financing_id = r.financing_id) AND ((uer.removed_ind)::text = \'Y\'::text))))) AND (r2.financing_id = fs.id) AND (r2.financing_id = r.financing_id) AND ((r2.registration_type_cl)::text = ANY (ARRAY[(\'CROWNLIEN\'::character varying)::text, (\'MISCLIEN\'::character varying)::text, (\'PPSALIEN\'::character varying)::text])))\nUNION\n SELECT r.registration_number,\n    r.registration_ts,\n    r.registration_type,\n    r.registration_type_cl,\n    uer.account_id,\n    rt.registration_desc,\n    r.base_reg_number,\n    r.id AS registration_id,\n    fs.id AS financing_id,\n        CASE\n            WHEN (((fs.state_type)::text = \'ACT\'::text) AND (fs.expire_date IS NOT NULL) AND ((fs.expire_date AT TIME ZONE \'utc\'::text) < (now() AT TIME ZONE \'utc\'::text))) THEN \'HEX\'::character varying\n            ELSE fs.state_type\n        END AS state,\n        CASE\n            WHEN (fs.life = 99) THEN \'-99\'::integer\n            ELSE (EXTRACT(days FROM ((fs.expire_date AT TIME ZONE \'utc\'::text) - (q.current_expire_ts)::timestamp with time zone)))::integer\n        END AS expire_days,\n    ( SELECT max(r2_1.registration_ts) AS max\n           FROM registrations r2_1\n          WHERE (r2_1.financing_id = r.financing_id)) AS last_update_ts,\n    ( SELECT\n                CASE\n                    WHEN (p.business_name IS NOT NULL) THEN (p.business_name)::text\n                    WHEN (p.branch_id IS NOT NULL) THEN (( SELECT client_codes.name\n                       FROM client_codes\n                      WHERE (client_codes.id = p.branch_id)))::text\n                    WHEN (p.middle_initial IS NOT NULL) THEN (((((p.first_name)::text || \' \'::text) || (p.middle_initial)::text) || \' \'::text) || (p.last_name)::text)\n                    ELSE (((p.first_name)::text || \' \'::text) || (p.last_name)::text)\n                END AS "case"\n           FROM parties p\n          WHERE ((p.registration_id = r.id) AND ((p.party_type)::text = \'RG\'::text))) AS registering_party,\n    ( SELECT string_agg(\n                CASE\n                    WHEN (p.business_name IS NOT NULL) THEN (p.business_name)::text\n                    WHEN (p.branch_id IS NOT NULL) THEN (( SELECT client_codes.name\n                       FROM client_codes\n                      WHERE (client_codes.id = p.branch_id)))::text\n                    WHEN (p.middle_initial IS NOT NULL) THEN (((((p.first_name)::text || \' \'::text) || (p.middle_initial)::text) || \' \'::text) || (p.last_name)::text)\n                    ELSE (((p.first_name)::text || \' \'::text) || (p.last_name)::text)\n                END, \', \'::text) AS string_agg\n           FROM parties p\n          WHERE ((p.financing_id = fs.id) AND (p.registration_id_end IS NULL) AND ((p.party_type)::text = \'SP\'::text))) AS secured_party,\n    r.client_reference_id,\n    ( SELECT\n                CASE\n                    WHEN (r.user_id IS NULL) THEN \'\'::text\n                    ELSE ( SELECT\n                            CASE\n                                WHEN (((u.lastname)::text = \'\'::text) OR (u.lastname IS NULL)) THEN (u.firstname)::text\n                                ELSE (((u.firstname)::text || \' \'::text) || (u.lastname)::text)\n                            END AS "case"\n                       FROM users u\n                      WHERE ((u.username)::text = (r.user_id)::text)\n                     LIMIT 1)\n                END AS "case") AS registering_name,\n    r.account_id AS orig_account_id,\n    r2.account_id AS base_account_id,\n    ( SELECT count(vr.id) AS count\n           FROM verification_reports vr\n          WHERE ((vr.registration_id = r.id) AND (vr.doc_storage_url IS NULL))) AS pending_count,\n    ( SELECT count(sc.id) AS count\n           FROM serial_collateral sc\n          WHERE ((sc.financing_id = fs.id) AND ((sc.registration_id = r.id) OR ((sc.registration_id <= r.id) AND ((sc.registration_id_end IS NULL) OR (sc.registration_id_end > r.id)))))) AS vehicle_count\n   FROM registrations r,\n    registration_types rt,\n    financing_statements fs,\n    user_extra_registrations uer,\n    registrations r2,\n    q\n  WHERE (((r.registration_type)::text = (rt.registration_type)::text) AND (fs.id = r.financing_id) AND ((fs.expire_date IS NULL) OR ((fs.expire_date AT TIME ZONE \'utc\'::text) > ((now() AT TIME ZONE \'utc\'::text) - \'30 days\'::interval))) AND (((r.registration_number)::text = (uer.registration_number)::text) OR ((r.base_reg_number)::text = (uer.registration_number)::text)) AND (uer.removed_ind IS NULL) AND (NOT (EXISTS ( SELECT r3.id\n           FROM registrations r3\n          WHERE ((r3.financing_id = fs.id) AND ((r3.registration_type_cl)::text = \'DISCHARGE\'::text) AND (r3.registration_ts < ((now() AT TIME ZONE \'utc\'::text) - \'30 days\'::interval)))))) AND (r2.financing_id = fs.id) AND (r2.financing_id = r.financing_id) AND ((r2.registration_type_cl)::text = ANY (ARRAY[(\'CROWNLIEN\'::character varying)::text, (\'MISCLIEN\'::character varying)::text, (\'PPSALIEN\'::character varying)::text])))'
    )
    op.replace_entity(public_account_registration_vw)

    public_account_registration_staff_vw = PGView(
        schema="public",
        signature="account_registration_staff_vw",
        definition='WITH q AS (\n         SELECT (now() AT TIME ZONE \'utc\'::text) AS current_expire_ts\n        )\n SELECT r.registration_number,\n    r.registration_ts,\n    r.registration_type,\n    r.registration_type_cl,\n    r.account_id,\n    rt.registration_desc,\n    r.base_reg_number,\n    r.id AS registration_id,\n    fs.id AS financing_id,\n        CASE\n            WHEN (((fs.state_type)::text = \'ACT\'::text) AND (fs.expire_date IS NOT NULL) AND ((fs.expire_date AT TIME ZONE \'utc\'::text) < (now() AT TIME ZONE \'utc\'::text))) THEN \'HEX\'::character varying\n            ELSE fs.state_type\n        END AS state,\n        CASE\n            WHEN (fs.life = 99) THEN \'-99\'::integer\n            ELSE (EXTRACT(days FROM ((fs.expire_date AT TIME ZONE \'utc\'::text) - (q.current_expire_ts)::timestamp with time zone)))::integer\n        END AS expire_days,\n    ( SELECT max(r2_1.registration_ts) AS max\n           FROM registrations r2_1\n          WHERE (r2_1.financing_id = r.financing_id)) AS last_update_ts,\n    ( SELECT\n                CASE\n                    WHEN (p.business_name IS NOT NULL) THEN (p.business_name)::text\n                    WHEN (p.branch_id IS NOT NULL) THEN (( SELECT client_codes.name\n                       FROM client_codes\n                      WHERE (client_codes.id = p.branch_id)))::text\n                    WHEN (p.middle_initial IS NOT NULL) THEN (((((p.first_name)::text || \' \'::text) || (p.middle_initial)::text) || \' \'::text) || (p.last_name)::text)\n                    ELSE (((p.first_name)::text || \' \'::text) || (p.last_name)::text)\n                END AS "case"\n           FROM parties p\n          WHERE ((p.registration_id = r.id) AND ((p.party_type)::text = \'RG\'::text))) AS registering_party,\n    ( SELECT string_agg(\n                CASE\n                    WHEN (p.business_name IS NOT NULL) THEN (p.business_name)::text\n                    WHEN (p.branch_id IS NOT NULL) THEN (( SELECT client_codes.name\n                       FROM client_codes\n                      WHERE (client_codes.id = p.branch_id)))::text\n                    WHEN (p.middle_initial IS NOT NULL) THEN (((((p.first_name)::text || \' \'::text) || (p.middle_initial)::text) || \' \'::text) || (p.last_name)::text)\n                    ELSE (((p.first_name)::text || \' \'::text) || (p.last_name)::text)\n                END, \', \'::text) AS string_agg\n           FROM parties p\n          WHERE ((p.financing_id = fs.id) AND (p.registration_id_end IS NULL) AND ((p.party_type)::text = \'SP\'::text))) AS secured_party,\n    r.client_reference_id,\n    ( SELECT\n                CASE\n                    WHEN (r.user_id IS NULL) THEN \'\'::text\n                    ELSE ( SELECT\n                            CASE\n                                WHEN (((u.lastname)::text = \'\'::text) OR (u.lastname IS NULL)) THEN (u.firstname)::text\n                                ELSE (((u.firstname)::text || \' \'::text) || (u.lastname)::text)\n                            END AS "case"\n                       FROM users u\n                      WHERE ((u.username)::text = (r.user_id)::text)\n                     LIMIT 1)\n                END AS "case") AS registering_name,\n    r.account_id AS orig_account_id,\n    r2.account_id AS base_account_id,\n    ( SELECT count(vr.id) AS count\n           FROM verification_reports vr\n          WHERE ((vr.registration_id = r.id) AND (vr.doc_storage_url IS NULL))) AS pending_count,\n    ( SELECT count(sc.id) AS count\n           FROM serial_collateral sc\n          WHERE ((sc.financing_id = fs.id) AND ((sc.registration_id = r.id) OR ((sc.registration_id <= r.id) AND ((sc.registration_id_end IS NULL) OR (sc.registration_id_end > r.id)))))) AS vehicle_count\n   FROM registrations r,\n    registration_types rt,\n    financing_statements fs,\n    registrations r2,\n    q\n  WHERE (((r.registration_type)::text = (rt.registration_type)::text) AND (fs.id = r.financing_id) AND (NOT (EXISTS ( SELECT r2_1.financing_id\n           FROM user_extra_registrations uer,\n            registrations r2_1\n          WHERE (((uer.registration_number)::text = (r2_1.registration_number)::text) AND (r2_1.financing_id = r.financing_id) AND ((uer.removed_ind)::text = \'Y\'::text))))) AND (r2.financing_id = fs.id) AND (r2.financing_id = r.financing_id) AND ((r2.registration_type_cl)::text = ANY (ARRAY[(\'CROWNLIEN\'::character varying)::text, (\'MISCLIEN\'::character varying)::text, (\'PPSALIEN\'::character varying)::text])))\nUNION\n SELECT r.registration_number,\n    r.registration_ts,\n    r.registration_type,\n    r.registration_type_cl,\n    uer.account_id,\n    rt.registration_desc,\n    r.base_reg_number,\n    r.id AS registration_id,\n    fs.id AS financing_id,\n        CASE\n            WHEN (((fs.state_type)::text = \'ACT\'::text) AND (fs.expire_date IS NOT NULL) AND ((fs.expire_date AT TIME ZONE \'utc\'::text) < (now() AT TIME ZONE \'utc\'::text))) THEN \'HEX\'::character varying\n            ELSE fs.state_type\n        END AS state,\n        CASE\n            WHEN (fs.life = 99) THEN \'-99\'::integer\n            ELSE (EXTRACT(days FROM ((fs.expire_date AT TIME ZONE \'utc\'::text) - (q.current_expire_ts)::timestamp with time zone)))::integer\n        END AS expire_days,\n    ( SELECT max(r2_1.registration_ts) AS max\n           FROM registrations r2_1\n          WHERE (r2_1.financing_id = r.financing_id)) AS last_update_ts,\n    ( SELECT\n                CASE\n                    WHEN (p.business_name IS NOT NULL) THEN (p.business_name)::text\n                    WHEN (p.branch_id IS NOT NULL) THEN (( SELECT client_codes.name\n                       FROM client_codes\n                      WHERE (client_codes.id = p.branch_id)))::text\n                    WHEN (p.middle_initial IS NOT NULL) THEN (((((p.first_name)::text || \' \'::text) || (p.middle_initial)::text) || \' \'::text) || (p.last_name)::text)\n                    ELSE (((p.first_name)::text || \' \'::text) || (p.last_name)::text)\n                END AS "case"\n           FROM parties p\n          WHERE ((p.registration_id = r.id) AND ((p.party_type)::text = \'RG\'::text))) AS registering_party,\n    ( SELECT string_agg(\n                CASE\n                    WHEN (p.business_name IS NOT NULL) THEN (p.business_name)::text\n                    WHEN (p.branch_id IS NOT NULL) THEN (( SELECT client_codes.name\n                       FROM client_codes\n                      WHERE (client_codes.id = p.branch_id)))::text\n                    WHEN (p.middle_initial IS NOT NULL) THEN (((((p.first_name)::text || \' \'::text) || (p.middle_initial)::text) || \' \'::text) || (p.last_name)::text)\n                    ELSE (((p.first_name)::text || \' \'::text) || (p.last_name)::text)\n                END, \', \'::text) AS string_agg\n           FROM parties p\n          WHERE ((p.financing_id = fs.id) AND (p.registration_id_end IS NULL) AND ((p.party_type)::text = \'SP\'::text))) AS secured_party,\n    r.client_reference_id,\n    ( SELECT\n                CASE\n                    WHEN (r.user_id IS NULL) THEN \'\'::text\n                    ELSE ( SELECT\n                            CASE\n                                WHEN (((u.lastname)::text = \'\'::text) OR (u.lastname IS NULL)) THEN (u.firstname)::text\n                                ELSE (((u.firstname)::text || \' \'::text) || (u.lastname)::text)\n                            END AS "case"\n                       FROM users u\n                      WHERE ((u.username)::text = (r.user_id)::text)\n                     LIMIT 1)\n                END AS "case") AS registering_name,\n    r.account_id AS orig_account_id,\n    r2.account_id AS base_account_id,\n    ( SELECT count(vr.id) AS count\n           FROM verification_reports vr\n          WHERE ((vr.registration_id = r.id) AND (vr.doc_storage_url IS NULL))) AS pending_count,\n    ( SELECT count(sc.id) AS count\n           FROM serial_collateral sc\n          WHERE ((sc.financing_id = fs.id) AND ((sc.registration_id = r.id) OR ((sc.registration_id <= r.id) AND ((sc.registration_id_end IS NULL) OR (sc.registration_id_end > r.id)))))) AS vehicle_count\n   FROM registrations r,\n    registration_types rt,\n    financing_statements fs,\n    user_extra_registrations uer,\n    registrations r2,\n    q\n  WHERE (((r.registration_type)::text = (rt.registration_type)::text) AND (fs.id = r.financing_id) AND (((r.registration_number)::text = (uer.registration_number)::text) OR ((r.base_reg_number)::text = (uer.registration_number)::text)) AND (uer.removed_ind IS NULL) AND (r2.financing_id = fs.id) AND (r2.financing_id = r.financing_id) AND ((r2.registration_type_cl)::text = ANY (ARRAY[(\'CROWNLIEN\'::character varying)::text, (\'MISCLIEN\'::character varying)::text, (\'PPSALIEN\'::character varying)::text])))'
    )
    op.replace_entity(public_account_registration_staff_vw)

    public_account_draft_vw = PGView(
        schema="public",
        signature="account_draft_vw",
        definition='SELECT d.document_number,\n    d.create_ts,\n    d.registration_type,\n    d.registration_type_cl,\n    rt.registration_desc,\n        CASE\n            WHEN ((d.registration_type_cl)::text = ANY (ARRAY[(\'PPSALIEN\'::character varying)::text, (\'CROWNLIEN\'::character varying)::text, (\'MISCLIEN\'::character varying)::text])) THEN \'\'::character varying\n            ELSE d.registration_number\n        END AS base_reg_num,\n    (d.draft ->> \'type\'::text) AS draft_type,\n        CASE\n            WHEN (d.update_ts IS NOT NULL) THEN d.update_ts\n            ELSE d.create_ts\n        END AS last_update_ts,\n        CASE\n            WHEN ((d.registration_type_cl)::text = ANY (ARRAY[(\'PPSALIEN\'::character varying)::text, (\'CROWNLIEN\'::character varying)::text, (\'MISCLIEN\'::character varying)::text])) THEN ((d.draft -> \'financingStatement\'::text) ->> \'clientReferenceId\'::text)\n            WHEN ((d.registration_type_cl)::text = \'AMENDMENT\'::text) THEN ((d.draft -> \'amendmentStatement\'::text) ->> \'clientReferenceId\'::text)\n            WHEN ((d.registration_type_cl)::text = \'CHANGE\'::text) THEN ((d.draft -> \'changeStatement\'::text) ->> \'clientReferenceId\'::text)\n            ELSE \'\'::text\n        END AS client_reference_id,\n        CASE\n            WHEN (((d.registration_type_cl)::text = ANY (ARRAY[(\'PPSALIEN\'::character varying)::text, (\'CROWNLIEN\'::character varying)::text, (\'MISCLIEN\'::character varying)::text])) AND (((d.draft -> \'financingStatement\'::text) -> \'registeringParty\'::text) IS NOT NULL)) THEN\n            CASE\n                WHEN ((((d.draft -> \'financingStatement\'::text) -> \'registeringParty\'::text) -> \'businessName\'::text) IS NOT NULL) THEN (((d.draft -> \'financingStatement\'::text) -> \'registeringParty\'::text) ->> \'businessName\'::text)\n                WHEN ((((d.draft -> \'financingStatement\'::text) -> \'registeringParty\'::text) ->> \'personName\'::text) IS NOT NULL) THEN concat(((((d.draft -> \'financingStatement\'::text) -> \'registeringParty\'::text) -> \'personName\'::text) ->> \'first\'::text), \' \', ((((d.draft -> \'financingStatement\'::text) -> \'registeringParty\'::text) -> \'personName\'::text) ->> \'last\'::text))\n                ELSE NULL::text\n            END\n            WHEN (((d.registration_type_cl)::text = \'AMENDMENT\'::text) AND (((d.draft -> \'amendmentStatement\'::text) -> \'registeringParty\'::text) IS NOT NULL)) THEN\n            CASE\n                WHEN ((((d.draft -> \'amendmentStatement\'::text) -> \'registeringParty\'::text) -> \'businessName\'::text) IS NOT NULL) THEN (((d.draft -> \'amendmentStatement\'::text) -> \'registeringParty\'::text) ->> \'businessName\'::text)\n                WHEN ((((d.draft -> \'amendmentStatement\'::text) -> \'registeringParty\'::text) -> \'personName\'::text) IS NOT NULL) THEN concat(((((d.draft -> \'amendmentStatement\'::text) -> \'registeringParty\'::text) -> \'personName\'::text) ->> \'first\'::text), \' \', ((((d.draft -> \'amendmentStatement\'::text) -> \'registeringParty\'::text) -> \'personName\'::text) ->> \'last\'::text))\n                ELSE NULL::text\n            END\n            ELSE \'\'::text\n        END AS registering_party,\n        CASE\n            WHEN (((d.registration_type_cl)::text = ANY (ARRAY[(\'PPSALIEN\'::character varying)::text, (\'CROWNLIEN\'::character varying)::text, (\'MISCLIEN\'::character varying)::text])) AND (((d.draft -> \'financingStatement\'::text) -> \'securedParties\'::text) IS NOT NULL)) THEN ( SELECT string_agg(\n                    CASE\n                        WHEN ((sp.value -> \'businessName\'::text) IS NOT NULL) THEN (sp.value ->> \'businessName\'::text)\n                        WHEN ((sp.value -> \'personName\'::text) IS NOT NULL) THEN concat(((sp.value -> \'personName\'::text) ->> \'first\'::text), \' \', ((sp.value -> \'personName\'::text) ->> \'last\'::text))\n                        ELSE NULL::text\n                    END, \',\'::text) AS string_agg\n               FROM json_array_elements(((d.draft -> \'financingStatement\'::text) -> \'securedParties\'::text)) sp(value))\n            WHEN (((d.registration_type_cl)::text = \'AMENDMENT\'::text) AND (((d.draft -> \'amendmentStatement\'::text) -> \'securedParties\'::text) IS NOT NULL)) THEN ( SELECT string_agg(\n                    CASE\n                        WHEN ((sp2.value -> \'businessName\'::text) IS NOT NULL) THEN (sp2.value ->> \'businessName\'::text)\n                        WHEN ((sp2.value -> \'personName\'::text) IS NOT NULL) THEN concat(((sp2.value -> \'personName\'::text) ->> \'first\'::text), \' \', ((sp2.value -> \'personName\'::text) ->> \'last\'::text))\n                        ELSE NULL::text\n                    END, \',\'::text) AS string_agg\n               FROM json_array_elements(((d.draft -> \'amendmentStatement\'::text) -> \'securedParties\'::text)) sp2(value))\n            ELSE \' \'::text\n        END AS secured_party,\n    ( SELECT\n                CASE\n                    WHEN (d.user_id IS NULL) THEN \'\'::text\n                    ELSE ( SELECT\n                            CASE\n                                WHEN (((u.lastname)::text = \'\'::text) OR (u.lastname IS NULL)) THEN (u.firstname)::text\n                                ELSE (((u.firstname)::text || \' \'::text) || (u.lastname)::text)\n                            END AS "case"\n                       FROM users u\n                      WHERE ((u.username)::text = (d.user_id)::text)\n                     LIMIT 1)\n                END AS "case") AS registering_name,\n    d.account_id,\n    d.id,\n    d.registration_number\n   FROM drafts d,\n    registration_types rt\n  WHERE ((d.registration_type)::text = (rt.registration_type)::text)'
    )
    op.replace_entity(public_account_draft_vw)
    # ### end Alembic commands ###
