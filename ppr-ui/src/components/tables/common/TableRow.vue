<template>
  <tr
    ref="tableRowRef"
    :class="{
      'registration-row': true,
      'rollover-effect': applyRolloverEffect,
      'base-registration-row': !isChild && !isDraft(item) && !applyAddedRegEffect,
      'draft-registration-row': isDraft(item) && !isChild,
      'font-italic': isDraft(item),
      'added-reg-effect': applyAddedRegEffect,
    }"
  >
    <td
      v-if="inSelectedHeaders('registrationNumber') || inSelectedHeaders('mhrNumber')"
      :class="{'border-left': (isChild || setIsExpanded), 'fix-td-width': hasRequiredTransfer(item) }"
    >
      <v-row noGutters>
        <v-col
          v-if="item.changes"
          class="pr-2"
          cols="auto"
        >
          <v-btn
            class="btn-row-expand-arr icon-large"
            color="primary"
            size="small"
            icon
            @click="toggleExpand(item)"
            @mouseover="rollover = true"
            @mouseleave="rollover = false"
          >
            <v-icon v-if="setIsExpanded">
              mdi-chevron-up
            </v-icon>
            <v-icon v-else>
              mdi-chevron-down
            </v-icon>
          </v-btn>
        </v-col>
        <v-col
          v-if="isRoleStaffReg && isChild && hasFrozenParentReg(item) &&
            (isTransAffi(item.registrationType) || isDraft(item))"
          cols="2"
        >
          <v-icon
            data-test-id="alert-icon"
            class="mt-n1"
            color="caution"
          >
            mdi-alert
          </v-icon>
        </v-col>
        <v-col style="padding-top: 2px;">
          <p
            v-if="isDraft(item)"
            class="ma-0"
            :class="isChild && !isTransAffi(item.registrationType) && !hasFrozenParentReg(item) ? 'pl-9': 'pl-1'"
          >
            Pending
          </p>
          <!-- child drafts will sometimes show outside their base reg during the sort -->
          <div
            v-if="isChild || (isDraft(item) && item.baseRegistrationNumber)"
            :class="!(isRoleStaffReg && isChild && hasFrozenParentReg(item) &&
              (isTransAffi(item.registrationType) || isDraft(item)))
              ? 'pl-9'
              : 'pl-1'"
          >
            <p
              v-if="isPpr"
              class="ma-0"
            >
              {{ item.registrationNumber }}
            </p>
            <p
              v-else-if="!isPpr && !isDraft(item)"
              style="font-size: 0.875rem;"
              class="ma-0"
            >
              {{ item.documentRegistrationNumber }}
            </p>
            <p
              class="ma-0"
              style="font-size: 0.75rem !important;"
            >
              <b>{{ (isPpr ? 'Base Registration: ' : 'MHR Number: ') }}<br>{{ item.baseRegistrationNumber }}</b>
            </p>
          </div>
          <p
            v-else
            class="ma-0"
          >
            <b>{{ item.baseRegistrationNumber || item.mhrNumber }}</b>
          </p>
          <!-- Lien Badge when one exists -->
          <InfoChip
            v-if="!isPpr && !isChild && hasLockedState(item)"
            action="LOCKED"
          />
          <InfoChip
            v-else-if="!isPpr && !isChild && hasLien(item)"
            action="LIEN"
          />
        </v-col>
      </v-row>

      <!-- Caution message for Frozen MHR state -->
      <v-row
        v-if="isRoleStaffReg && hasRequiredTransfer(item)"
        :class="item.changes && 'pt-4'"
      >
        <v-col>
          <p class="text-no-wrap pt-5">
            <v-icon
              data-test-id="alert-icon"
              class="mt-n2"
              color="caution"
            >
              mdi-alert
            </v-icon>
            <span class="pl-2">A Transfer Due to Sale or Gift must be completed.</span>
          </p>
        </v-col>
      </v-row>
    </td>
    <td
      v-if="inSelectedHeaders('registrationType') || inSelectedHeaders('registrationDescription')"
      :class="isChild || item.expanded ? 'border-left': ''"
    >
      <div v-if="isPpr && !!item.registrationType">
        {{ getRegistrationType(item.registrationType) }}
        <span v-if="isPpr && !isChild"> - Base Registration</span>
      </div>
      <div
        v-else
        class="pr-2"
      >
        {{ multipleWordsToTitleCase(item.registrationDescription, true) }}
        <span v-if="item.cancelledDocumentDescription && showCancelledDocumentDescription(item)">
          {{ `(${multipleWordsToTitleCase(item.cancelledDocumentDescription, true)})` }}
        </span>
        <v-tooltip
          v-if="item.registrationDescription === APIMhrDescriptionTypes.CONVERTED"
          class="pa-2"
          contentClass="top-tooltip"
          location="top"
          transition="fade-transition"
        >
          <template #activator="{ props }">
            <v-icon
              style="vertical-align: baseline"
              color="primary"
              size="small"
              v-bind="props"
            >
              mdi-information-outline
            </v-icon>
          </template>
          <div class="pt-2 pb-2">
            The records for this registration were converted from paper to digital format on November 14, 1995, and may
            not contain the full history of transactions prior to the conversion date.
          </div>
        </v-tooltip>
      </div>
      <v-btn
        v-if="item.changes"
        class="btn-row-expand-txt btn-txt pa-0 generic-link"
        color="primary"
        variant="plain"
        @click="toggleExpand(item)"
        @mouseover="rollover = true"
        @mouseleave="rollover = false"
      >
        <label style="cursor: pointer;">
          <span v-if="!setIsExpanded">View </span>
          <span v-else>Hide </span>
          {{ isPpr ? 'Amendments' : 'History' }}
        </label>
      </v-btn>
    </td>
    <td
      v-if="inSelectedHeaders('createDateTime')"
      :class="isChild || item.expanded ? 'border-left': ''"
    >
      <span v-if="!isDraft(item)">
        {{ getFormattedDate(item.createDateTime) }}
      </span>
      <span v-else>
        Not Registered
      </span>
    </td>
    <td
      v-if="inSelectedHeaders('statusType')"
      :class="isChild || item.expanded ? 'border-left': ''"
    >
      <div v-if="!isChild || isDraft(item) || !isPpr">
        {{
          isMhrTransfer(item) && !isChild ?
            'Completed' : getStatusDescription(item.statusType, isChild, isPpr, isDraft(item))
        }}
        <p
          v-if="!isChild && item.hasDraft"
          class="ma-0"
        >
          <i>{{ isPpr ? '* Draft Amendment' : '* Draft Changes' }}</i>
        </p>
      </div>
    </td>
    <td
      v-if="inSelectedHeaders('registeringName')"
      :class="isChild || item.expanded ? 'border-left': ''"
    >
      <span v-if="item.registeringName">{{ getRegisteringName(item.registeringName) }}</span>
      <span v-else>{{ item.username || 'N/A' }}</span>
    </td>
    <td
      v-if="inSelectedHeaders('registeringParty')"
      :class="isChild || item.expanded ? 'border-left': ''"
    >
      {{ item.registeringParty || item.submittingParty }}
    </td>
    <td
      v-if="inSelectedHeaders('ownerNames')"
      :class="isChild || item.expanded ? 'border-left': ''"
    >
      {{ item.ownerNames }}
    </td>
    <td
      v-if="inSelectedHeaders('securedParties') && isPpr"
      :class="isChild || item.expanded ? 'border-left': ''"
    >
      {{ item.securedParties || '' }}
    </td>
    <td
      v-if="inSelectedHeaders('clientReferenceId')"
      :class="isChild || item.expanded ? 'border-left': ''"
    >
      {{ item.clientReferenceId }}
    </td>
    <td
      v-if="inSelectedHeaders('expireDays')"
      :class="isChild || item.expanded ? 'border-left': ''"
      v-html="showExpireDays(item)"
    />
    <td
      v-if="inSelectedHeaders('vs')"
      :class="isChild || item.expanded ? 'border-left': ''"
    >
      <v-btn
        v-if="!isDraft(item) && item.path"
        :id="`pdf-btn-${item.id}`"
        class="pdf-btn px-0 mt-n3"
        variant="plain"
        :loading="item.path === loadingPDF"
        @click="downloadPDF(item)"
      >
        <img src="@/assets/svgs/pdf-icon-blue.svg">
        <span class="pl-1">PDF</span>
      </v-btn>
      <v-tooltip
        v-else-if="!isDraft(item)"
        contentClass="top-tooltip"
        location="top"
        transition="fade-transition"
      >
        <template #activator="{ props }">
          <v-icon
            color="primary"
            v-bind="props"
            @click="refresh(item)"
          >
            mdi-information-outline
          </v-icon>
        </template>
        <div>
          <span v-html="tooltipTxtPdf(item)" />
        </div>
      </v-tooltip>
    </td>

    <!--Action Btns-->
    <td
      v-if="headers.length > 1"
      class="actions-cell"
      :class="{ 'actions-cell-min': headers.length < 3 }"
      :style="disableActionShadow ? 'box-shadow: none; border-left: none;' : ''"
    >
      <!-- PPR ACTIONS -->
      <v-row
        v-if="isPpr && (!isChild || isDraft(item))"
        class="actions pr-4"
        noGutters
      >
        <v-col
          cols="10"
          class="edit-action"
        >
          <v-btn
            v-if="isDraft(item)"
            class="edit-btn"
            color="primary"
            @click="editDraft(item)"
          >
            <span>Edit</span>
          </v-btn>
          <v-btn
            v-else-if="isRepairersLien(item) && isActive(item)"
            class="edit-btn"
            color="primary"
            @click="handleAction(item, TableActions.DISCHARGE)"
          >
            <span class="discharge-btn text-wrap fs-12">Total Discharge</span>
          </v-btn>
          <v-btn
            v-else-if="!isExpired(item) && !isDischarged(item)"
            class="edit-btn"
            color="primary"
            @click="handleAction(item, TableActions.AMEND)"
          >
            <span>Amend</span>
          </v-btn>
          <v-btn
            v-else
            color="primary"
            class="remove-btn"
            @click="handleAction(item, TableActions.REMOVE)"
          >
            <span class="fs-12">Remove From Table</span>
          </v-btn>
        </v-col>

        <!-- Menu Dropdown -->
        <v-col
          v-if="!isExpired(item) && !isDischarged(item)"
          class="actions__more"
          cols="1"
        >
          <v-menu
            v-model="menuToggleState"
            location="bottom right"
            @mouseleave="menuToggleState = false"
          >
            <template #activator="{ props }">
              <v-btn
                color="primary"
                class="actions__more-actions__btn reg-table down-btn"
                v-bind="props"
              >
                <v-icon v-if="menuToggleState">
                  mdi-menu-up
                </v-icon>
                <v-icon v-else>
                  mdi-menu-down
                </v-icon>
              </v-btn>
            </template>
            <v-list
              v-if="isDraft(item)"
              class="actions__more-actions registration-actions draft-actions"
            >
              <v-list-item
                @click="deleteDraft(item, TableActions.DELETE)"
              >
                <v-list-item-subtitle>
                  <v-icon size="small">
                    mdi-delete
                  </v-icon>
                  <span class="ml-1">Delete Draft</span>
                </v-list-item-subtitle>
              </v-list-item>
            </v-list>
            <v-list
              v-else
              class="actions__more-actions registration-actions"
            >
              <v-tooltip
                location="bottom right"
                contentClass="left-tooltip pa-2 mr-2 pl-4"
                transition="fade-transition"
                :disabled="!isRepairersLienAmendDisabled(item)"
              >
                <template #activator="{ props }">
                  <div v-bind="props">
                    <v-list-item
                      v-if="isRepairersLien(item)"
                      :disabled="isRepairersLienAmendDisabled(item)"
                      @click="handleAction(item, TableActions.AMEND)"
                    >
                      <v-list-item-subtitle>
                        <v-icon size="small">
                          mdi-pencil
                        </v-icon>
                        <span class="ml-1">Amend</span>
                      </v-list-item-subtitle>
                    </v-list-item>
                  </div>
                </template>
                <span>
                  This lien has only one item of vehicle collateral and cannot be amended.
                </span>
              </v-tooltip>
              <v-list-item
                v-if="isActive(item) && !isExpired(item) && !isDischarged(item) && !isRepairersLien(item)"
                @click="handleAction(item, TableActions.DISCHARGE)"
              >
                <v-list-item-subtitle>
                  <v-icon size="small">
                    mdi-note-remove-outline
                  </v-icon>
                  <span class="ml-1">Total Discharge</span>
                </v-list-item-subtitle>
              </v-list-item>
              <v-tooltip
                location="bottom right"
                contentClass="left-tooltip pa-2 mr-2"
                transition="fade-transition"
                :disabled="!isRenewalDisabled(item)"
              >
                <template #activator="{ props }">
                  <div v-bind="props">
                    <v-list-item
                      v-if="isActive(item) && !isExpired(item) && !isDischarged(item)"
                      :disabled="isRenewalDisabled(item)"
                      @click="handleAction(item, TableActions.RENEW)"
                    >
                      <v-list-item-subtitle>
                        <v-icon size="small">
                          mdi-calendar-clock
                        </v-icon>
                        <span class="ml-1">Renew</span>
                      </v-list-item-subtitle>
                    </v-list-item>
                  </div>
                </template>
                <span v-if="item.expireDays === -99">
                  Infinite registrations cannot be renewed.
                </span>
              </v-tooltip>
              <v-list-item @click="handleAction(item, TableActions.REMOVE)">
                <v-list-item-subtitle>
                  <v-icon size="small">
                    mdi-delete
                  </v-icon>
                  <span class="ml-1">Remove From Table</span>
                </v-list-item-subtitle>
              </v-list-item>
            </v-list>
          </v-menu>
        </v-col>
      </v-row>

      <!--      MHR ACTIONS-->
      <v-row
        v-else-if="isEnabledMhr(item)"
        class="actions pr-4"
        noGutters
      >
        <v-col
          class="edit-action pa-0"
          cols="10"
        >
          <v-btn
            color="primary"
            class="edit-btn"
            @click="openMhr(item)"
          >
            <span>Open</span>
          </v-btn>
        </v-col>
        <v-col
          class="actions__more pa-0"
          cols="1"
        >
          <v-menu
            v-model="menuToggleState"
            location="bottom right"
            @mouseleave="menuToggleState = false"
          >
            <template #activator="{ props, value }">
              <v-btn
                color="primary"
                class="actions__more-actions__btn reg-table down-btn"
                v-bind="props"
              >
                <v-icon v-if="value">
                  mdi-menu-up
                </v-icon>
                <v-icon v-else>
                  mdi-menu-down
                </v-icon>
              </v-btn>
            </template>
            <v-list class="actions__more-actions registration-actions">
              <v-list-item
                v-if="isRoleStaffReg && isExemptionEnabled && isExemptOrCancelled(item.statusType)"
                data-test-id="rescind-exemption-btn"
                @click="openExemption(UnitNoteDocTypes.RESCIND_EXEMPTION, item)"
              >
                <v-list-item-subtitle>
                  <img
                    alt="exemption-icon"
                    class="ml-0 icon-small"
                    src="@/assets/svgs/ic_re-register-home.svg"
                  >
                  <span class="ml-1">Re-Register Manufactured Home</span>
                </v-list-item-subtitle>
              </v-list-item>
              <v-list-item
                v-if="isExemptionEnabled && !hasChildResExemption(item) &&
                  ![HomeLocationTypes.HOME_PARK, HomeLocationTypes.LOT].includes(item.locationType)"
                data-test-id="res-exemption-btn"
                :disabled="item.frozenDocumentType === MhApiFrozenDocumentTypes.TRANS_AFFIDAVIT"
                @click="hasLienForQS || hasLockedForQS
                  ? null
                  : openExemption(UnitNoteDocTypes.RESIDENTIAL_EXEMPTION_ORDER, item)"
              >
                <v-list-item-subtitle>
                  <v-tooltip
                    v-if="hasLienForQS || hasLockedForQS"
                    location="left"
                    content-class="left-tooltip pa-5"
                    transition="fade-transition"
                  >
                    <template #activator="{ props }">
                      <span
                        class="disabled-text"
                        v-bind="props"
                      >
                        <img
                          alt="exemption-icon"
                          class="ml-0 icon-small"
                          src="@/assets/svgs/ic_exemption2.svg"
                        >
                        Residential Exemption
                      </span>
                    </template>
                    {{ hasLienForQS
                      ? 'There is a lien on this home preventing an exemption to be filed.'
                      : `There is a lock on this home preventing an exemption to be filed.
                      If you require further information please contact BC Registries staff.`
                    }}
                  </v-tooltip>
                  <span v-else>
                    <img
                      alt="exemption-icon"
                      class="ml-0 icon-small"
                      src="@/assets/svgs/ic_exemption2.svg"
                    >
                    <span class="ml-1">Residential Exemption</span>
                  </span>
                </v-list-item-subtitle>
              </v-list-item>
              <v-list-item
                v-if="isRoleStaffReg && isExemptionEnabled"
                data-test-id="non-res-exemption-btn"
                :disabled="!isNonResExemptionEnabled ||
                  item.frozenDocumentType === MhApiFrozenDocumentTypes.TRANS_AFFIDAVIT"
                @click="openExemption(UnitNoteDocTypes.NON_RESIDENTIAL_EXEMPTION, item)"
              >
                <v-list-item-subtitle>
                  <img
                    alt="exemption-icon"
                    class="icon-small"
                    src="@/assets/svgs/ic_exemption.svg"
                  >
                  <span class="ml-1">Non-Residential Exemption</span>
                </v-list-item-subtitle>
              </v-list-item>
              <v-list-item
                data-test-id="remove-mhr-row-btn"
                @click="handleAction(item, TableActions.REMOVE)"
              >
                <v-list-item-subtitle>
                  <v-icon size="small">
                    mdi-delete
                  </v-icon>
                  <span class="ml-1">Remove From Table</span>
                </v-list-item-subtitle>
              </v-list-item>
            </v-list>
          </v-menu>
        </v-col>
      </v-row>

      <!--      MHR DRAFT ACTIONS-->
      <v-row
        v-else-if="!isPpr && isDraft(item)"
        class="actions pr-4"
        noGutters
      >
        <v-col
          class="edit-action"
          cols="10"
        >
          <v-btn
            color="primary"
            class="edit-btn"
            @click="openMhr(item)"
          >
            <span>Edit</span>
          </v-btn>
        </v-col>
        <v-col
          class="actions__more"
          cols="1"
        >
          <v-menu
            v-model="menuToggleState"
            location="bottom right"
            @mouseleave="menuToggleState = false"
          >
            <template #activator="{ props }">
              <v-btn
                color="primary"
                class="actions__more-actions__btn reg-table down-btn"
                v-bind="props"
              >
                <v-icon v-if="menuToggleState">
                  mdi-menu-up
                </v-icon>
                <v-icon v-else>
                  mdi-menu-down
                </v-icon>
              </v-btn>
            </template>
            <v-list class="actions__more-actions registration-actions">
              <v-list-item @click="removeMhrDraft(item)">
                <v-list-item-subtitle>
                  <v-icon size="small">
                    mdi-delete
                  </v-icon>
                  <span class="ml-1">Delete Draft</span>
                </v-list-item-subtitle>
              </v-list-item>
            </v-list>
          </v-menu>
        </v-col>
      </v-row>
    </td>
  </tr>
</template>

<script lang="ts">
import { computed, defineComponent, reactive, toRefs, watch } from 'vue'
import {
  getRegistrationSummary, mhRegistrationPDF, registrationPDF, stripChars,
  multipleWordsToTitleCase, getMHRegistrationSummary, isWithinMinutes
} from '@/utils'
import { useStore } from '@/store/store'
import InfoChip from '@/components/common/InfoChip.vue'

import {
  BaseHeaderIF,
  DraftResultIF,
  MhRegistrationSummaryIF,
  RegistrationSummaryIF
} from '@/interfaces'

import {
  APIMhrDescriptionTypes,
  APIMhrTypes,
  APIRegistrationTypes,
  APIStatusTypes,
  DraftTypes,
  TableActions,
  UIRegistrationClassTypes,
  UITransferTypes,
  MhApiStatusTypes,
  MhApiFrozenDocumentTypes,
  UnitNoteDocTypes,
  HomeLocationTypes
} from '@/enums'
import { useRegistration } from '@/composables/useRegistration'
import { useExemptions, useTransferOwners } from '@/composables'
import moment from 'moment'
import { storeToRefs } from 'pinia'
import { QSLockedStateUnitNoteTypes } from '@/resources'

export default defineComponent({
  name: 'TableRow',
  components: { InfoChip },
  props: {
    isPpr: { type: Boolean, default: false },
    setAddRegEffect: { type: Boolean, default: false },
    setDisableActionShadow: { type: Boolean, default: false },
    setChild: { type: Boolean, default: false },
    setHeaders: { type: Array as () => BaseHeaderIF[], default: [] as BaseHeaderIF[] },
    setIsExpanded: { type: Boolean, default: false },
    closeSubMenu: { type: Boolean, default: false },
    setItem: {
      default: () => {
      },
      type: Object as () => RegistrationSummaryIF | DraftResultIF | MhRegistrationSummaryIF | any
    }
  },
  emits: ['action', 'error', 'freezeScroll', 'toggleExpand'],
  setup (props, { emit }) {
    const {
      getAccountLabel,
      isRoleQualifiedSupplier,
      isRoleStaff,
      isRoleStaffSbc,
      isRoleStaffBcol,
      isRoleStaffReg,
      getMhRegTableBaseRegs
    } = storeToRefs(useStore())

    const {
      getFormattedDate,
      getRegistrationType,
      getStatusDescription,
      getRegisteringName,
      registrationNumber,
      registeringParty,
      hasRenewal,
      securedParties
    } = useRegistration(null)
    const { isTransAffi } = useTransferOwners()
    const { isExemptionEnabled, isNonResExemptionEnabled, hasChildResExemption } = useExemptions()

    const localState = reactive({
      loadingPDF: '',
      rollover: false,
      menuToggleState: false,
      applyAddedRegEffect: computed((): boolean => {
        return props.setAddRegEffect
      }),
      applyRolloverEffect: computed((): boolean => {
        return localState.rollover || props.setIsExpanded
      }),
      disableActionShadow: computed((): boolean => {
        return props.setDisableActionShadow
      }),
      headers: computed(() => {
        return props.setHeaders
      }),
      isChild: computed(() => {
        return props.setChild
      }),
      item: computed<any>(() => {
        if (!isDraft(props.setItem) && !props.setChild) {
          // if base reg && not draft check to update expand
          const baseReg = props.setItem as RegistrationSummaryIF
          if (baseReg.expand !== undefined && (baseReg.expand !== props.setIsExpanded)) {
            toggleExpand(props.setItem)
          }
        }
        return props.setItem
      }),
      enableOpenEdit: computed(() => {
        return (isRoleQualifiedSupplier.value || isRoleStaffReg.value || isRoleStaff.value || isRoleStaffSbc.value) &&
          !isRoleStaffBcol.value
      }),
      hasLienForQS: computed(() => {
        return isRoleQualifiedSupplier.value &&
          localState.item.lienRegistrationType &&
          localState.item.lienRegistrationType !== APIRegistrationTypes.SECURITY_AGREEMENT
      }),
      hasLockedForQS: computed(() => {
       return  hasLockedState(localState.item) && isRoleQualifiedSupplier.value
      })
    })

    const hasRequiredTransfer = (item: MhRegistrationSummaryIF) => {
      return !props.isPpr && !localState.isChild &&
        item.statusType === MhApiStatusTypes.FROZEN &&
        item.frozenDocumentType === MhApiFrozenDocumentTypes.TRANS_AFFIDAVIT
    }


    const deleteDraft = (item: DraftResultIF): void => {
      emit('action', {
        action: TableActions.DELETE,
        docId: item.documentId,
        regNum: item.baseRegistrationNumber
      })
    }

    const tooltipTxtPdf = (item: RegistrationSummaryIF) => {
      // Display messaging for client accounts when the submitting party doesn't match the current account
      const isNotMhrSubmittingParty = !props.isPpr && item.submittingParty?.toUpperCase() !==
        getAccountLabel.value?.toUpperCase()

      // Sbc Staff can't rely on Submitting Party Match and cannot view all docs like Reg Staff
      // Fall through to the 'download' messaging if user is SBC and this filing is recent.
      const isRecentSbcFiling = isRoleStaffSbc.value && isWithinMinutes(item.createDateTime, 10)

      if (isNotMhrSubmittingParty && !isRoleStaffReg.value && !isRecentSbcFiling) {
        return 'Documents are only available to the Submitting Party of this filing. To view the details of this' +
          ' registration you must conduct a search.'
      }

      const isVerificationStatement = !item.registeringName && props.isPpr
      if (isVerificationStatement) {
        return 'Verification Statements are only available to Secured Parties or the Registering Party of this ' +
          'filing. To view the details of this registration you must conduct a search.'
      }

      // Display Legacy messaging if the filing was flagged as completed in the legacy system
      if (isRoleStaffReg.value && item.legacy) {
        return 'Document only available in the legacy system.'
      }

      return 'This document PDF is still being generated. Click the ' +
        '<i class="v-icon notranslate mdi mdi-information-outline" style="font-size:18px; margin-bottom:4px;"></i>' +
        ' icon to see if your PDF is ready to download. <br>' +
        'Note: Large documents may take up to 20 minutes to generate.'
    };


    const downloadPDF = async (item: RegistrationSummaryIF): Promise<any> => {
      localState.loadingPDF = item.path
      const pdf = props.isPpr ? await registrationPDF(item.path) : await mhRegistrationPDF(item.path)
      if (pdf.error) {
        emit('error', pdf.error)
      } else {
        /* solution from https://github.com/axios/axios/issues/1392 */

        // it is necessary to create a new blob object with mime-type explicitly set
        // otherwise only Chrome works like it should
        const blob = new Blob([pdf], { type: 'application/pdf' })

        // IE doesn't allow using a blob object directly as link href
        // instead it is necessary to use msSaveOrOpenBlob
        if (window.navigator && (window.navigator as any).msSaveOrOpenBlob) {
          (window.navigator as any).msSaveOrOpenBlob(blob, item.path)
        } else {
          // for other browsers, create a link pointing to the ObjectURL containing the blob
          const url = window.URL.createObjectURL(blob)
          const a = window.document.createElement('a')
          window.document.body.appendChild(a)
          a.setAttribute('style', 'display: none')
          a.href = url
          // Format (PPR): [Date (in YYYY-MM-DD format)] BCPPR [Two Letter Registration Type Code
          // (only for Standard Registrations)] [Verification Statement Type] - [Registration Number]
          // Example: 2022-01-03 BCPPR SA Registration Verification - 100559B

          // Format (MHR): [Date (in YYYY-MM-DD format)] BCMHR [Registration || Transfer] - [Registration Number]
          // Example: 2023-03-13 BCMHR Registration - 150378

          const today = new Date()
          const regType = props.isPpr ? '_BCPPR_' : isMhrTransfer(item) ? '_BCMHR_Transfer' : '_BCMHR_Registration'
          const regClass = getRegistrationClass(item.registrationClass) || ''
          if (regClass === 'Registration Verification') {
            a.download = today.toISOString().slice(0, 10) + regType +
              item.registrationType + '_' + regClass.replace(/ /g, '_') + '_' + item.registrationNumber
          } else {
            a.download = today.toISOString().slice(0, 10) + regType +
              regClass.replace(/ /g, '_') + '_' + (item.registrationNumber || item.baseRegistrationNumber)
          }
          a.click()
          window.URL.revokeObjectURL(url)
          a.remove()
        }
      }
      localState.loadingPDF = ''
    }

    const editDraft = (item: DraftResultIF): void => {
      if (item?.type === DraftTypes.FINANCING_STATEMENT) {
        emit('action', { action: TableActions.EDIT_NEW, docId: item.documentId })
      } else if (item?.type === DraftTypes.AMENDMENT_STATEMENT) {
        emit('action', {
          action: TableActions.EDIT_AMEND,
          docId: item.documentId,
          regNum: item.baseRegistrationNumber
        })
      }
    }

    const isEnabledMhr = (item: MhRegistrationSummaryIF) => {
      return [MhApiStatusTypes.ACTIVE, MhApiStatusTypes.FROZEN, MhApiStatusTypes.EXEMPT, MhApiStatusTypes.CANCELLED]
          .includes(item.statusType as MhApiStatusTypes) &&
        localState.enableOpenEdit && (item.registrationDescription === APIMhrDescriptionTypes.REGISTER_NEW_UNIT ||
          item.registrationDescription === APIMhrDescriptionTypes.CONVERTED)
    }

    const openMhr = (item: MhRegistrationSummaryIF): void => {
      let action: TableActions

      switch (item.registrationType) {
        case APIMhrTypes.REGISTRY_STAFF_ADMIN:
          action = TableActions.OPEN_DRAFT_CORRECTION
          break
        case APIMhrTypes.MANUFACTURED_HOME_REGISTRATION:
          action = item.draftNumber ? TableActions.EDIT_NEW_MHR : TableActions.OPEN_MHR
          break
        default:
          action = TableActions.OPEN_MHR
          break
      }

      emit('action', {
        action: action,
        mhrInfo: item
      })
    }

    const openExemption = (docType: UnitNoteDocTypes, item: MhRegistrationSummaryIF): void => {
      emit('action', {
        action: docType,
        mhrInfo: item
      })
    }

    const isMhrTransfer = (item: any): boolean => {
      const formattedTransferTypes = [
        UITransferTypes.SALE_OR_GIFT,
        UITransferTypes.SURVIVING_JOINT_TENANT,
        UITransferTypes.TO_ADMIN_NO_WILL,
        UITransferTypes.TO_EXECUTOR_PROBATE_WILL,
        UITransferTypes.TO_EXECUTOR_UNDER_25K_WILL
      ].map(type => stripChars(type).toUpperCase())

      return [MhApiStatusTypes.ACTIVE, MhApiStatusTypes.FROZEN].includes(item.statusType) &&
        formattedTransferTypes.includes(stripChars(item.registrationDescription))
    }

    const removeMhrDraft = (item: MhRegistrationSummaryIF): void => {
      emit('action', { action: TableActions.DELETE, regNum: item.draftNumber })
    }

    const getRegistrationClass = (regClass: string): string => {
      return UIRegistrationClassTypes[regClass]
    }

    const freezeScrolling = (isMenuOpen: boolean) => {
      emit('freezeScroll', isMenuOpen)
    }

    const handleAction = (item, action: TableActions): void => {
      const registrationNumber = props.isPpr
        ? item.baseRegistrationNumber
        : item.mhrNumber

      emit('action', { action, regNum: registrationNumber })
    }

    const inSelectedHeaders = (search: string) => {
      return localState.headers.find(header => {
        return header.value === search
      })
    }

    const isActive = (item: RegistrationSummaryIF): boolean => {
      return item.statusType === APIStatusTypes.ACTIVE
    }

    const hasFrozenParentReg = (item: MhRegistrationSummaryIF): boolean => {
      const parentReg = item.mhrNumber && getMhRegTableBaseRegs.value?.find(reg => reg.mhrNumber === item.mhrNumber)
      return parentReg?.statusType === MhApiStatusTypes.FROZEN
    }

    // locked state for MHR based on API response (eg. TAXN Unit Note is blocking QS)
    const hasLockedState = (item: MhRegistrationSummaryIF): boolean => {
      const parentReg: MhRegistrationSummaryIF =
        item.mhrNumber && getMhRegTableBaseRegs.value?.find(reg => reg.mhrNumber === item.mhrNumber)
      // For QS status will be frozen, but for Staff it will be Active, so no locked state would be shown
      return (isRoleQualifiedSupplier.value && parentReg?.statusType === MhApiStatusTypes.FROZEN) &&
        (QSLockedStateUnitNoteTypes.includes(parentReg?.frozenDocumentType) ||
          parentReg?.frozenDocumentType === MhApiFrozenDocumentTypes.TRANS_AFFIDAVIT)
    }

    const isDischarged = (item: RegistrationSummaryIF): boolean => {
      return item.statusType === APIStatusTypes.DISCHARGED
    }

    const isRenewalDisabled = (item: RegistrationSummaryIF): boolean => {
      return (item.expireDays === -99)
    }

    const isRepairersLienAmendDisabled = (item: RegistrationSummaryIF): boolean => {
      const changes = item?.changes as RegistrationSummaryIF[]
      // if there are amendments, get the vehicle count from the first array element
      if (changes) {
        const lastChange = changes[0]
        return (lastChange.vehicleCount === 1)
      }
      return (item.vehicleCount === 1)
    }

    const isDraft = (item: any): boolean => {
      // RegistrationSummaryIF | DraftResultIF | MhrDraftApiIF
      return props.isPpr
        ? item.type !== undefined
        : (item.statusType === MhApiStatusTypes.DRAFT || item.statusType === undefined || !item.mhrNumber)
    }

    const isExpired = (item: RegistrationSummaryIF): boolean => {
      return item.statusType === APIStatusTypes.EXPIRED
    }

    const isRepairersLien = (item: RegistrationSummaryIF): boolean => {
      return item.registrationType === APIRegistrationTypes.REPAIRERS_LIEN
    }

    const isExemptOrCancelled = (statusType: MhApiStatusTypes): boolean =>
      [MhApiStatusTypes.EXEMPT, MhApiStatusTypes.CANCELLED].includes(statusType)

    const refresh = async (item: RegistrationSummaryIF): Promise<void> => {
      // could be base reg or child reg
      if (item.registeringName) {
        // will always return base reg
        const resp = await getRegistrationSummary(item.registrationNumber, true)
        if (resp.error) {
          // log error, but otherwise ignore it
          console.error('Refreshing registration failed: ', resp.error)
        } else {
          if (item.registrationNumber === resp.registrationNumber) item.path = resp.path
          else {
            // find child in changes and set path to that
            const changes = resp?.changes as RegistrationSummaryIF[]
            const child = changes.find(reg => reg.registrationNumber === item.registrationNumber)
            if (!child) {
              // log error, but otherwise ignore it
              console.error(
                `Could not find registration ${item.registrationNumber} within base reg changes: `,
                resp.changes
              )
            } else {
              item.path = child.path
            }
          }
        }
        // Mhr Handling
      } else if (
        (item.submittingParty?.toUpperCase() === getAccountLabel.value?.toUpperCase()) || isRoleStaffReg.value ||
        isRoleStaffSbc.value && isWithinMinutes(item.createDateTime, 10)
    ) {
        const resp = await getMHRegistrationSummary(item.baseRegistrationNumber, true)
        if (resp.error) {
          // log error, but otherwise ignore it
          console.error('Refreshing registration failed: ', resp.error)
        } else {
          if (item.documentRegistrationNumber === resp.documentRegistrationNumber) item.path = resp.path
          else {
            // find child in changes and set path to that
            const changes = resp?.changes as RegistrationSummaryIF[]
            const child = changes.find(reg => reg.documentRegistrationNumber === item.documentRegistrationNumber)
            if (!child) {
              // log error, but otherwise ignore it
              console.error(
                `Could not find registration ${item.documentRegistrationNumber} within base reg changes: `,
                resp.changes
              )
            } else {
              item.path = child.path
            }
          }
        }
      }
    }

    const showExpireDays = (item: RegistrationSummaryIF): string => {
      if (localState.isChild && props.isPpr) return ''
      if (isExpired(item) || isDischarged(item)) return '—'

      const days = item.expireDays
      // -9999 indicates the notice of caution has been cancelled
      if (days === null || days === undefined || days === -9999) {
        return 'N/A'
      }
      if (days === -99) {
        return 'Infinite'
      }
      if (days <= 0) {
        return 'Expired'
      } else {
        if (days > 364) {
          const today = new Date()
          const expireDate = new Date()
          // expireDate.setDate(expireDate.getDate() + days)
          const dateExpiry = moment.utc(new Date(
            Date.UTC(
              expireDate.getUTCFullYear(),
              expireDate.getUTCMonth(),
              expireDate.getUTCDate()
            )
          )).add(days, 'days')
          const dateToday = moment.utc(new Date(
            Date.UTC(
              today.getUTCFullYear(),
              today.getUTCMonth(),
              today.getUTCDate()
            )
          ))

          // year difference
          const years = dateExpiry.diff(dateToday, 'years')
          if (years > 0) {
            dateExpiry.subtract(years, 'year')
          }
          // day difference
          const daysDiff = dateExpiry.diff(dateToday, 'days')
          let yearText = ' years '
          if (years === 1) {
            yearText = ' year '
          }

          return years.toString() + yearText + daysDiff.toString() + ' days'
        }
        if (days <= 2) {
          return `<span class="error-text">${days} ${days === 1 ? 'day' : 'days' }</span>`
        }
        return days.toString() + ' days'
      }
    }

    const toggleExpand = (val: any) => {
      emit('toggleExpand', val)
    }

    const hasLien = (item: any): boolean => {
      // Future state might require type handling
      return !!item.lienRegistrationType
    }

    // Hide cancelled document decs for Notice Of Redemption for child item in MHR table
    const showCancelledDocumentDescription = (mhrTableChildItem): boolean => {
      // Notice of Redemption is cancelled only by Notice of Tax Sale, so check for type to hide the desc
      return mhrTableChildItem.cancelledDocumentType !== UnitNoteDocTypes.NOTICE_OF_TAX_SALE
    }

    watch(() => props.setItem, () => {
    }, { deep: true, immediate: true })

    return {
      hasRequiredTransfer,
      multipleWordsToTitleCase,
      freezeScrolling,
      APIMhrDescriptionTypes,
      getFormattedDate,
      getRegistrationType,
      getStatusDescription,
      getRegisteringName,
      showExpireDays,
      deleteDraft,
      editDraft,
      handleAction,
      refresh,
      registrationNumber,
      registeringParty,
      securedParties,
      isActive,
      isDischarged,
      isDraft,
      isExpired,
      isRepairersLien,
      isExemptOrCancelled,
      isRenewalDisabled,
      isRepairersLienAmendDisabled,
      isRoleStaffReg,
      isRoleQualifiedSupplier,
      isExemptionEnabled,
      hasChildResExemption,
      hasRenewal,
      downloadPDF,
      inSelectedHeaders,
      TableActions,
      toggleExpand,
      tooltipTxtPdf,
      openMhr,
      openExemption,
      isEnabledMhr,
      removeMhrDraft,
      isMhrTransfer,
      hasLien,
      showCancelledDocumentDescription,
      isTransAffi,
      hasFrozenParentReg,
      hasLockedState,
      MhApiFrozenDocumentTypes,
      UnitNoteDocTypes,
      HomeLocationTypes,
      isNonResExemptionEnabled,
      ...toRefs(localState)
    }
  }
})
</script>

<style lang="scss" scoped>
@import '@/assets/styles/theme.scss';

.registration-row {
  // $blueSelected 0.5 opacity colour at full opacity (needed for .actions-cell overlay)
  background-color: #f2f6fb;
  -moz-transition: background-color 1.5s ease;
  -o-transition: background-color 1.5s ease;
  -webkit-transition: background-color 1.5s ease;
  transition: background-color 1.5s ease;
  z-index: 3;

  td {
    vertical-align: top;
    border-bottom: thin solid rgba(0, 0, 0, .12)
  }
}

.base-registration-row {
  background-color: white;
  font-weight: bold;
}

.added-reg-effect {
  background-color: $greenSelected;
  font-weight: bold;
}

.v-table--density-default > .v-table__wrapper > table > tbody > tr > td {
  padding-left: 24px;
  height: calc(var(--v-table-row-height, 75px));
}

.rollover-effect {
  background-color: $blueSelected !important;
}

.draft-registration-row {
  // $gray1 0.5 opacity colour at full opacity (needed for .actions-cell overlay)
  background: #f8f9fa !important;
}

.actions-cell {
  .v-btn:not(.v-btn--round).v-btn--size-default {
    width: 100%;
    min-height: unset !important;
  }
}

.v-btn {
  max-height: 34px;
}

.remove-btn {
  margin-left: -5px;
  min-width: 120px;
}

.edit-btn, .discharge-btn {
  border-bottom-right-radius: 0;
  border-top-right-radius: 0;
}

.down-btn {
  min-width: unset;
  border-bottom-left-radius: 0;
  border-top-left-radius: 0;
}

.fix-td-width {
  max-width: 100px; /* Adjust to your preference */
  white-space: nowrap;
  text-overflow: ellipsis;
}
</style>
