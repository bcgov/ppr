<template>
  <tr :class="{
      'registration-row': true,
      'rollover-effect': applyRolloverEffect,
      'base-registration-row': !isChild && !isDraft(item),
      'draft-registration-row': isDraft(item) && !isChild,
      'font-italic': isDraft(item),
      'added-reg-effect': applyAddedRegEffect,
    }"
  >
    <td
      v-if="inSelectedHeaders('registrationNumber') || inSelectedHeaders('mhrNumber')"
      :class="(isChild || setIsExpanded) ? 'border-left': ''"
    >
      <v-row no-gutters>
        <v-col v-if="item.changes" class="pr-2" cols="auto">
          <v-btn
            class="btn-row-expand-arr btn-expand"
            color="white"
            icon
            small
            @click="toggleExpand(item)"
            @mouseover="rollover = true"
            @mouseleave="rollover = false"
          >
            <v-icon v-if="setIsExpanded">mdi-chevron-up</v-icon>
            <v-icon v-else>mdi-chevron-down</v-icon>
          </v-btn>
        </v-col>
        <v-col
          v-if="isChild && hasFrozenParentReg(item) && (isTransAffi(item.registrationType) || isDraft(item))"
          cols="2"
        >
          <v-icon data-test-id="alert-icon" class="mt-n1" color="caution">mdi-alert</v-icon>
        </v-col>
        <v-col style="padding-top: 2px;">
          <p
            v-if="isDraft(item)"
            class="ma-0"
            :class="isChild && !isTransAffi(item.registrationType) && !hasFrozenParentReg(item) ? 'pl-9': 'pl-1'"
          >Pending</p>
          <!-- child drafts will sometimes show outside their base reg during the sort -->
          <div
            v-if="isChild || (isDraft(item) && item.baseRegistrationNumber)"
            :class="!(isChild && hasFrozenParentReg(item) && (isTransAffi(item.registrationType) || isDraft(item)))
            ? 'pl-9'
            : 'pl-1'"
          >
            <p v-if="isPpr" class="ma-0">{{ item.registrationNumber }}</p>
            <p v-else-if="!isPpr && !isDraft(item)" style="font-size: 0.875rem;" class="ma-0">
              {{ item.documentRegistrationNumber }}
            </p>
            <p class="ma-0" style="font-size: 0.75rem !important;">
              <b>{{ (isPpr ? 'Base Registration: ' : 'MHR Number: ')}}<br>{{ item.baseRegistrationNumber }}</b>
            </p>
          </div>
          <p v-else class="ma-0">
            <b>{{ item.baseRegistrationNumber || item.mhrNumber }}</b>
          </p>
          <!-- Lien Badge when one exists -->
          <InfoChip v-if="!isPpr && !isChild && hasLien(item)" action="LIEN"></InfoChip>
        </v-col>
      </v-row>

      <!-- Caution message for Frozen MHR state -->
      <v-row
        v-if="!isPpr && !isChild && item.statusType === MhApiStatusTypes.FROZEN"
        class="mt-8"
        :class="item.changes && 'pt-4'"
      >
        <v-col class="pb-0">
          <p class="mb-0 text-no-wrap">
            <v-icon data-test-id="alert-icon" class="mt-n1" color="caution">mdi-alert</v-icon>
            <span class="pl-3">A Transfer Due to Sale or Gift must be completed.</span>
          </p>
        </v-col>
      </v-row>
    </td>
    <td
      v-if="inSelectedHeaders('registrationType') || inSelectedHeaders('registrationDescription')"
      :class="isChild || item.expanded ? 'border-left': ''"
    >
      <div v-if="isPpr && !!item.registrationType">
        {{ getRegistrationType(item.registrationType) }}
        <span v-if="isPpr && !isChild"> - Base Registration</span>
      </div>
      <div v-else class="pr-2">{{ item.registrationDescription }}
        <v-tooltip
          v-if="item.registrationDescription === APIMhrDescriptionTypes.CONVERTED"
          class="pa-2"
          content-class="top-tooltip"
          nudge-right="2"
          top
          transition="fade-transition"
        >
          <template v-slot:activator="{ on, attrs }">
            <v-icon style="vertical-align: baseline" color="primary" small v-bind="attrs" v-on="on">
              mdi-information-outline
            </v-icon>
          </template>
          <div class="pt-2 pb-2">
            The records for this registration were converted from paper to digital format on November 14, 1995, and may
            not contain the full history of transactions prior to the conversion date.
          </div>
        </v-tooltip>
      </div>
      <v-btn
        v-if="item.changes"
        class="btn-row-expand-txt btn-txt pa-0"
        color="primary"
        text
        underlined
        @click="toggleExpand(item)"
        @mouseover="rollover = true"
        @mouseleave="rollover = false"
      >
        <label style="cursor: pointer;">
          <span v-if="!setIsExpanded">View </span>
          <span v-else>Hide </span>
          {{ isPpr ? 'Amendments' : 'History' }}
        </label>
      </v-btn>
    </td>
    <td v-if="inSelectedHeaders('createDateTime')" :class="isChild || item.expanded ? 'border-left': ''">
      <span v-if="!isDraft(item)">
        {{ getFormattedDate(item.createDateTime) }}
      </span>
      <span v-else>
        Not Registered
      </span>
    </td>
    <td
      v-if="inSelectedHeaders('statusType')"
      :class="isChild || item.expanded ? 'border-left': ''"
    >
      <div v-if="!isChild || isDraft(item) || !isPpr">
        {{  isMhrTransfer(item) ?
        'Completed' : getStatusDescription(item.statusType, isChild, isPpr) }}
        <p v-if="!isChild && item.hasDraft" class="ma-0">
          <i>{{ isPpr ? '* Draft Amendment' : '* Draft Changes' }}</i>
        </p>
      </div>
    </td>
    <td
      v-if="inSelectedHeaders('registeringName')"
      :class="isChild || item.expanded ? 'border-left': ''"
    >
      <span v-if="item.registeringName">{{ getRegisteringName(item.registeringName) }}</span>
      <span v-else>{{ item.username || 'N/A' }}</span>
    </td>
    <td
      v-if="inSelectedHeaders('registeringParty')"
      :class="isChild || item.expanded ? 'border-left': ''"
    >
      {{ item.registeringParty || item.submittingParty }}
    </td>
    <td
      v-if="inSelectedHeaders('ownerNames')"
      :class="isChild || item.expanded ? 'border-left': ''"
    >
      {{ item.ownerNames}}
    </td>
    <td
      v-if="inSelectedHeaders('securedParties') && isPpr"
      :class="isChild || item.expanded ? 'border-left': ''"
    >
      {{ item.securedParties || '' }}
    </td>
    <td
      v-if="inSelectedHeaders('clientReferenceId')"
      :class="isChild || item.expanded ? 'border-left': ''"
    >
      {{ item.clientReferenceId }}
    </td>
    <td
      v-if="inSelectedHeaders('expireDays')"
      v-html="showExpireDays(item)"
      :class="isChild || item.expanded ? 'border-left': ''"
    />
    <td
      v-if="inSelectedHeaders('vs')"
      :class="isChild || item.expanded ? 'border-left': ''"
    >
      <v-btn
        :id="`pdf-btn-${item.id}`"
        v-if="!isDraft(item) && item.path"
        class="pdf-btn px-0 mt-n3"
        depressed
        :loading="item.path === loadingPDF"
        @click="downloadPDF(item)"
      >
        <img src="@/assets/svgs/pdf-icon-blue.svg">
        <span class="pl-1">PDF</span>
      </v-btn>
      <v-tooltip
        v-else-if="!isDraft(item)"
        class="pa-2"
        content-class="top-tooltip"
        nudge-right="2"
        top
        transition="fade-transition"
      >
        <template v-slot:activator="{ on, attrs }">
          <v-icon color="primary" v-bind="attrs" v-on="on" @click="refresh(item)">mdi-information-outline</v-icon>
        </template>
        <div class="pt-2 pb-2">
          <span v-html="tooltipTxtPdf(item)"></span>
        </div>
      </v-tooltip>
    </td>

    <!-- Action Btns -->
    <td
      v-if="headers.length > 1"
      class="actions-cell pl-2 py-4"
      :style="disableActionShadow ? 'box-shadow: none; border-left: none;' : ''"
    >
      <!-- PPR ACTIONS -->
      <v-row v-if="isPpr && (!isChild || isDraft(item))" class="actions" no-gutters>
        <v-col class="edit-action pa-0" cols="auto">
          <v-btn
            v-if="isDraft(item)"
            class="edit-btn"
            color="primary"
            elevation="0"
            @click="editDraft(item)"
          >
            <span>Edit</span>
          </v-btn>
          <v-btn
            v-else-if="isRepairersLien(item) && isActive(item)"
            class="edit-btn"
            style="flex:0"
            color="primary"
            elevation="0"
            @click="handleAction(item, TableActions.DISCHARGE)"
          >
            <span class="discharge-btn text-wrap">Total Discharge</span>
          </v-btn>
          <v-btn
            v-else-if="!isExpired(item) && !isDischarged(item)"
            class="edit-btn"
            color="primary"
            elevation="0"
            @click="handleAction(item, TableActions.AMEND)"
          >
            <span>Amend</span>
          </v-btn>
          <v-btn
            v-else
            color="primary"
            style="height:36px"
            elevation="0"
            @click="handleAction(item, TableActions.REMOVE)"
          >
            <span class="remove-btn text-wrap">Remove From<br>Table</span>
          </v-btn>
        </v-col>
        <v-col class="actions__more pa-0" v-if="!isExpired(item) && !isDischarged(item)">
          <v-menu offset-y left nudge-bottom="4" @input="freezeScrolling($event)">
            <template v-slot:activator="{ on: onMenu, value }">
              <v-btn
                small
                elevation="0"
                v-on="onMenu"
                color="primary"
                class="actions__more-actions__btn reg-table down-btn"
              >
                <v-icon v-if="value">mdi-menu-up</v-icon>
                <v-icon v-else>mdi-menu-down</v-icon>
              </v-btn>
            </template>
            <v-list v-if="isDraft(item)" class="actions__more-actions registration-actions">
              <v-list-item
                @click="deleteDraft(item, TableActions.DELETE)"
              >
                <v-list-item-subtitle>
                  <v-icon small>mdi-delete</v-icon>
                  <span class="ml-1">Delete Draft</span>
                </v-list-item-subtitle>
              </v-list-item>
            </v-list>
            <v-list v-else class="actions__more-actions registration-actions">
              <v-tooltip
                left
                content-class="left-tooltip pa-2 mr-2 pl-4"
                transition="fade-transition"
                :disabled="!isRepairersLienAmendDisabled(item)"
              >
                <template v-slot:activator="{ on: onTooltip }">
                  <div v-on="onTooltip">
                    <v-list-item
                      v-if="isRepairersLien(item)"
                      :disabled="isRepairersLienAmendDisabled(item)"
                      @click="handleAction(item, TableActions.AMEND)"
                    >
                      <v-list-item-subtitle>
                        <v-icon small>mdi-pencil</v-icon>
                        <span class="ml-1">Amend</span>
                      </v-list-item-subtitle>
                    </v-list-item>
                  </div>
                </template>
                <span>
                  This lien has only one item of vehicle collateral and cannot be amended.
                </span>
              </v-tooltip>
              <v-list-item
                v-if="isActive(item) && !isExpired(item) && !isDischarged(item) && !isRepairersLien(item)"
                @click="handleAction(item, TableActions.DISCHARGE)"
              >
                <v-list-item-subtitle>
                  <v-icon small>mdi-note-remove-outline</v-icon>
                  <span class="ml-1">Total Discharge</span>
                </v-list-item-subtitle>
              </v-list-item>
              <v-tooltip
                left
                content-class="left-tooltip pa-2 mr-2"
                transition="fade-transition"
                :disabled="!isRenewalDisabled(item)"
              >
                <template v-slot:activator="{ on: onTooltip }">
                  <div v-on="onTooltip">
                    <v-list-item
                      v-if="isActive(item) && !isExpired(item) && !isDischarged(item)"
                      :disabled="isRenewalDisabled(item)"
                      @click="handleAction(item, TableActions.RENEW)"
                    >
                      <v-list-item-subtitle>
                        <v-icon small>mdi-calendar-clock</v-icon>
                        <span class="ml-1">Renew</span>
                      </v-list-item-subtitle>
                    </v-list-item>
                  </div>
                </template>
                <span v-if="item.expireDays === -99">
                  Infinite registrations cannot be renewed.
                </span>
              </v-tooltip>
              <v-list-item @click="handleAction(item, TableActions.REMOVE)">
                <v-list-item-subtitle>
                  <v-icon small>mdi-delete</v-icon>
                  <span class="ml-1">Remove From Table</span>
                </v-list-item-subtitle>
              </v-list-item>
            </v-list>
          </v-menu>
        </v-col>
      </v-row>

      <!-- MHR ACTIONS -->
      <v-row v-else-if="isEnabledMhr(item)" class="actions" no-gutters>
        <v-col class="edit-action pa-0" cols="auto">
          <v-btn
            color="primary"
            elevation="0"
            width="100"
            class="edit-btn"
            @click="openMhr(item)"
          >
            <span>Open</span>
          </v-btn>
        </v-col>
        <v-col class="actions__more pa-0">
          <v-menu offset-y left nudge-bottom="4" @input="freezeScrolling($event)">
            <template v-slot:activator="{ on: onMenu, value }">
              <v-btn
                small
                elevation="0"
                v-on="onMenu"
                color="primary"
                class="actions__more-actions__btn reg-table down-btn"
              >
                <v-icon v-if="value">mdi-menu-up</v-icon>
                <v-icon v-else>mdi-menu-down</v-icon>
              </v-btn>
            </template>
            <v-list class="actions__more-actions registration-actions">
              <v-list-item @click="handleAction(item, TableActions.REMOVE)">
                <v-list-item-subtitle>
                  <v-icon small>mdi-delete</v-icon>
                  <span class="ml-1">Remove From Table</span>
                </v-list-item-subtitle>
              </v-list-item>
            </v-list>
          </v-menu>
        </v-col>
      </v-row>

      <!-- MHR DRAFT ACTIONS -->
      <v-row v-else-if="!isPpr && isDraft(item)" class="actions" no-gutters>
        <v-col class="edit-action pa-0" cols="auto">
          <v-btn
            color="primary"
            elevation="0"
            width="100"
            class="edit-btn"
            @click="openMhr(item)"
          >
            <span>Edit</span>
          </v-btn>
        </v-col>
        <v-col class="actions__more pa-0">
          <v-menu offset-y left nudge-bottom="4" @input="freezeScrolling($event)">
            <template v-slot:activator="{ on: onMenu, value }">
              <v-btn
                small
                elevation="0"
                v-on="onMenu"
                color="primary"
                class="actions__more-actions__btn reg-table down-btn"
              >
                <v-icon v-if="value">mdi-menu-up</v-icon>
                <v-icon v-else>mdi-menu-down</v-icon>
              </v-btn>
            </template>
            <v-list class="actions__more-actions registration-actions">
              <v-list-item @click="removeMhrDraft(item)">
                <v-list-item-subtitle>
                  <v-icon small>mdi-delete</v-icon>
                  <span class="ml-1">Delete Draft</span>
                </v-list-item-subtitle>
              </v-list-item>
            </v-list>
          </v-menu>
        </v-col>
      </v-row>
    </td>
  </tr>
</template>

<script lang="ts">
import { computed, defineComponent, reactive, toRefs, watch } from 'vue-demi'
import { getRegistrationSummary, mhRegistrationPDF, registrationPDF, stripChars } from '@/utils'
import { useStore } from '@/store/store'
import InfoChip from '@/components/common/InfoChip.vue'
/* eslint-disable no-unused-vars */
import {
  BaseHeaderIF,
  DraftResultIF,
  MhRegistrationSummaryIF,
  RegistrationSummaryIF,
  RegTableNewItemI
} from '@/interfaces'
/* eslint-enable no-unused-vars */
import {
  APIMhrDescriptionTypes,
  APIMhrTypes,
  APIRegistrationTypes,
  APIStatusTypes,
  DraftTypes,
  TableActions,
  UIRegistrationClassTypes,
  UITransferTypes,
  MhApiStatusTypes
} from '@/enums'
import { useRegistration } from '@/composables/useRegistration'
import { useTransferOwners } from '@/composables'
import moment from 'moment'
import { storeToRefs } from 'pinia'

export default defineComponent({
  name: 'TableRow',
  components: { InfoChip },
  props: {
    isPpr: { type: Boolean, default: false },
    setAddRegEffect: { default: false },
    setDisableActionShadow: { default: false },
    setChild: { default: false },
    setHeaders: { default: [] as BaseHeaderIF[] },
    setIsExpanded: { default: false },
    setItem: {
      default: () => {},
      type: Object as () => RegistrationSummaryIF | DraftResultIF | MhRegistrationSummaryIF | any
    }
  },
  emits: ['action', 'error', 'freezeScroll', 'toggleExpand'],
  setup (props, { emit }) {
    const {
      isRoleQualifiedSupplier,
      isRoleStaff,
      isRoleStaffSbc,
      isRoleStaffBcol,
      isRoleStaffReg,
      getMhRegTableBaseRegs
    } = storeToRefs(useStore())

    const {
      getFormattedDate,
      getRegistrationType,
      getStatusDescription,
      getRegisteringName,
      registrationNumber,
      registeringParty,
      hasRenewal,
      securedParties
    } = useRegistration(null)
    const { isTransAffi } = useTransferOwners()

    const localState = reactive({
      loadingPDF: '',
      rollover: false,
      applyAddedRegEffect: computed((): boolean => {
        return props.setAddRegEffect
      }),
      applyRolloverEffect: computed((): boolean => {
        return localState.rollover || props.setIsExpanded
      }),
      disableActionShadow: computed((): boolean => {
        return props.setDisableActionShadow
      }),
      headers: computed(() => {
        return props.setHeaders
      }),
      isChild: computed(() => {
        return props.setChild
      }),
      item: computed<any>(() => {
        if (!isDraft(props.setItem) && !props.setChild) {
          // if base reg && not draft check to update expand
          const baseReg = props.setItem as RegistrationSummaryIF
          if (baseReg.expand !== undefined && (baseReg.expand !== props.setIsExpanded)) {
            toggleExpand(props.setItem)
          }
        }
        return props.setItem
      }),
      enableOpenEdit: computed(() => {
        return (isRoleQualifiedSupplier.value || isRoleStaffReg.value || isRoleStaff.value) &&
          !isRoleStaffSbc.value && !isRoleStaffBcol.value
      })
    })

    const deleteDraft = (item: DraftResultIF): void => {
      emit('action', {
        action: TableActions.DELETE,
        docId: item.documentId,
        regNum: item.baseRegistrationNumber
      })
    }

    const tooltipTxtPdf = (item): string => {
      if (!props.isPpr) {
        return 'Documents are only available to the Submitting Party of this filing. To view the details of this ' +
          'registration you must conduct a search.'
      } else if (!item.registeringName) {
        return 'Verification Statements are only available ' +
      'to Secured Parties or the Registering Party of this filing. To ' +
      'view the details of this registration you must conduct a search.'
      } else {
        return 'This document PDF is still being generated. Click the ' +
        '<i class="v-icon notranslate mdi mdi-information-outline" style="font-size:18px; margin-bottom:4px;"></i>' +
        ' icon to see if your PDF is ready to download. <br>' +
        'Note: Large documents may take up to 20 minutes to generate.'
      }
    }

    const downloadPDF = async (item: RegistrationSummaryIF): Promise<any> => {
      localState.loadingPDF = item.path
      const pdf = props.isPpr ? await registrationPDF(item.path) : await mhRegistrationPDF(item.path)
      if (pdf.error) {
        emit('error', pdf.error)
      } else {
        /* solution from https://github.com/axios/axios/issues/1392 */

        // it is necessary to create a new blob object with mime-type explicitly set
        // otherwise only Chrome works like it should
        const blob = new Blob([pdf], { type: 'application/pdf' })

        // IE doesn't allow using a blob object directly as link href
        // instead it is necessary to use msSaveOrOpenBlob
        if (window.navigator && (window.navigator as any).msSaveOrOpenBlob) {
          (window.navigator as any).msSaveOrOpenBlob(blob, item.path)
        } else {
          // for other browsers, create a link pointing to the ObjectURL containing the blob
          const url = window.URL.createObjectURL(blob)
          const a = window.document.createElement('a')
          window.document.body.appendChild(a)
          a.setAttribute('style', 'display: none')
          a.href = url
          // Format (PPR): [Date (in YYYY-MM-DD format)] BCPPR [Two Letter Registration Type Code
          // (only for Standard Registrations)] [Verification Statement Type] - [Registration Number]
          // Example: 2022-01-03 BCPPR SA Registration Verification - 100559B

          // Format (MHR): [Date (in YYYY-MM-DD format)] BCMHR [Registration || Transfer] - [Registration Number]
          // Example: 2023-03-13 BCMHR Registration - 150378

          const today = new Date()
          const regType = props.isPpr ? '_BCPPR_' : isMhrTransfer(item) ? '_BCMHR_Transfer' : '_BCMHR_Registration'
          const regClass = getRegistrationClass(item.registrationClass) || ''
          if (regClass === 'Registration Verification') {
            a.download = today.toISOString().slice(0, 10) + regType +
              item.registrationType + '_' + regClass.replace(/ /g, '_') + '_' + item.registrationNumber
          } else {
            a.download = today.toISOString().slice(0, 10) + regType +
              regClass.replace(/ /g, '_') + '_' + (item.registrationNumber || item.baseRegistrationNumber)
          }
          a.click()
          window.URL.revokeObjectURL(url)
          a.remove()
        }
      }
      localState.loadingPDF = ''
    }

    const editDraft = (item: DraftResultIF): void => {
      if (item?.type === DraftTypes.FINANCING_STATEMENT) {
        emit('action', { action: TableActions.EDIT_NEW, docId: item.documentId })
      } else if (item?.type === DraftTypes.AMENDMENT_STATEMENT) {
        emit('action', {
          action: TableActions.EDIT_AMEND,
          docId: item.documentId,
          regNum: item.baseRegistrationNumber
        })
      }
    }

    const isEnabledMhr = (item: MhRegistrationSummaryIF) => {
      return [MhApiStatusTypes.ACTIVE, MhApiStatusTypes.FROZEN].includes(item.statusType as MhApiStatusTypes) &&
        localState.enableOpenEdit && (item.registrationDescription === APIMhrDescriptionTypes.REGISTER_NEW_UNIT ||
          item.registrationDescription === APIMhrDescriptionTypes.CONVERTED)
    }

    const openMhr = (item: MhRegistrationSummaryIF): void => {
      emit('action', {
        action: (item.registrationType === APIMhrTypes.MANUFACTURED_HOME_REGISTRATION && item.draftNumber)
          ? TableActions.EDIT_NEW_MHR
          : TableActions.OPEN_MHR,
        mhrInfo: item
      })
    }

    const isMhrTransfer = (item: any): boolean => {
      const formattedTransferTypes = [
        UITransferTypes.SALE_OR_GIFT,
        UITransferTypes.SURVIVING_JOINT_TENANT,
        UITransferTypes.TO_ADMIN_NO_WILL,
        UITransferTypes.TO_EXECUTOR_PROBATE_WILL,
        UITransferTypes.TO_EXECUTOR_UNDER_25K_WILL
      ].map(type => stripChars(type).toUpperCase())

      return [MhApiStatusTypes.ACTIVE, MhApiStatusTypes.FROZEN].includes(item.statusType) &&
        formattedTransferTypes.includes(stripChars(item.registrationDescription))
    }

    const removeMhrDraft = (item: MhRegistrationSummaryIF): void => {
      emit('action', { action: TableActions.DELETE, regNum: item.draftNumber })
    }

    const getRegistrationClass = (regClass: string): string => {
      return UIRegistrationClassTypes[regClass]
    }

    const freezeScrolling = (isMenuOpen: boolean) => {
      emit('freezeScroll', isMenuOpen)
    }

    const handleAction = (item, action: TableActions): void => {
      const registrationNumber = props.isPpr
        ? item.baseRegistrationNumber
        : item.mhrNumber

      emit('action', { action: action, regNum: registrationNumber })
    }

    const inSelectedHeaders = (search: string) => {
      return localState.headers.find(header => { return header.value === search })
    }

    const isActive = (item: RegistrationSummaryIF): boolean => {
      return item.statusType === APIStatusTypes.ACTIVE
    }

    const hasFrozenParentReg = (item: MhRegistrationSummaryIF): boolean => {
      const parentReg = item.mhrNumber && getMhRegTableBaseRegs.value?.find(reg => reg.mhrNumber === item.mhrNumber)
      return parentReg?.statusType === MhApiStatusTypes.FROZEN
    }

    const isDischarged = (item: RegistrationSummaryIF): boolean => {
      return item.statusType === APIStatusTypes.DISCHARGED
    }

    const isRenewalDisabled = (item: RegistrationSummaryIF): boolean => {
      return (item.expireDays === -99)
    }

    const isRepairersLienAmendDisabled = (item: RegistrationSummaryIF): boolean => {
      const changes = item?.changes as RegistrationSummaryIF[]
      // if there are amendments, get the vehicle count from the first array element
      if (changes) {
        const lastChange = changes[0]
        return (lastChange.vehicleCount === 1)
      }
      return (item.vehicleCount === 1)
    }

    const isDraft = (item: any): boolean => {
      // RegistrationSummaryIF | DraftResultIF | MhrDraftApiIF
      return props.isPpr
        ? item.type !== undefined
        : (item.statusType === MhApiStatusTypes.DRAFT || item.statusType === undefined || !item.mhrNumber)
    }

    const isExpired = (item: RegistrationSummaryIF): boolean => {
      return item.statusType === APIStatusTypes.EXPIRED
    }

    const isRepairersLien = (item: RegistrationSummaryIF): boolean => {
      return item.registrationType === APIRegistrationTypes.REPAIRERS_LIEN
    }

    const refresh = async (item: RegistrationSummaryIF): Promise<void> => {
      // could be base reg or child reg
      if (item.registeringName) {
        // will always return base reg
        const resp = await getRegistrationSummary(item.registrationNumber, true)
        if (resp.error) {
          // log error, but otherwise ignore it
          console.error('Refreshing registration failed: ', resp.error)
        } else {
          if (item.registrationNumber === resp.registrationNumber) item.path = resp.path
          else {
            // find child in changes and set path to that
            const changes = resp?.changes as RegistrationSummaryIF[]
            const child = changes.find(reg => reg.registrationNumber === item.registrationNumber)
            if (!child) {
              // log error, but otherwise ignore it
              console.error(
                `Could not find registration ${item.registrationNumber} within base reg changes: `,
                resp.changes
              )
            } else {
              item.path = child.path
            }
          }
        }
      }
    }

    const showExpireDays = (item: RegistrationSummaryIF): string => {
      if (localState.isChild && props.isPpr) return ''
      if (isExpired(item) || isDischarged(item)) return '—'

      const days = item.expireDays
      if (days === null || days === undefined) {
        return 'N/A'
      }
      if (days === -99) {
        return 'Infinite'
      } else {
        if (days > 364) {
          const today = new Date()
          const expireDate = new Date()
          // expireDate.setDate(expireDate.getDate() + days)
          var dateExpiry = moment(new Date(
            Date.UTC(
              expireDate.getUTCFullYear(),
              expireDate.getUTCMonth(),
              expireDate.getUTCDate()
            )
          )).add(days, 'days')
          var dateToday = moment(new Date(
            Date.UTC(
              today.getUTCFullYear(),
              today.getUTCMonth(),
              today.getUTCDate()
            )
          ))

          // year difference
          const years = dateExpiry.diff(dateToday, 'years')
          if (years > 0) {
            dateExpiry.subtract(years, 'year')
          }
          // day difference
          const daysDiff = dateExpiry.diff(dateToday, 'days')
          let yearText = ' years '
          if (years === 1) {
            yearText = ' year '
          }
          return years.toString() + yearText + daysDiff.toString() + ' days'
        }
        if (days < 30) {
          return (
            '<span class="invalid-color">' +
            days.toString() +
            ' days' +
            '</span>'
          )
        }
        return days.toString() + ' days'
      }
    }

    const toggleExpand = (val: any) => {
      emit('toggleExpand', val)
    }

    const hasLien = (item: any): boolean => {
      // Future state might require type handling
      return !!item.lienRegistrationType
    }

    watch(() => props.setItem, (val) => {
    }, { deep: true, immediate: true })

    return {
      freezeScrolling,
      MhApiStatusTypes,
      APIMhrDescriptionTypes,
      getFormattedDate,
      getRegistrationType,
      getStatusDescription,
      getRegisteringName,
      showExpireDays,
      deleteDraft,
      editDraft,
      handleAction,
      refresh,
      registrationNumber,
      registeringParty,
      securedParties,
      isActive,
      isDischarged,
      isDraft,
      isExpired,
      isRepairersLien,
      isRenewalDisabled,
      isRepairersLienAmendDisabled,
      hasRenewal,
      downloadPDF,
      inSelectedHeaders,
      TableActions,
      toggleExpand,
      tooltipTxtPdf,
      openMhr,
      isEnabledMhr,
      removeMhrDraft,
      isMhrTransfer,
      hasLien,
      isTransAffi,
      hasFrozenParentReg,
      ...toRefs(localState)
    }
  }
})
</script>

<style lang="scss" scoped>
@import '@/assets/styles/theme.scss';
.border-left:nth-child(1) {
  border-left: 3px solid $primary-blue
}
.btn-expand {
  background-color: $primary-blue;
  height: 25px !important;
  width: 25px !important;
}
.btn-txt, .btn-txt::before, .btn-txt::after {
  background-color: transparent !important;
  font-size: 0.75rem !important;
  height: 14px !important;
  min-width: 0 !important;
  text-decoration: underline;
}
.down-btn {
  border-bottom-left-radius: 0;
  border-top-left-radius: 0;
  height: 35px !important;
  width: 35px;
}
.edit-btn {
  border-bottom-right-radius: 0;
  border-top-right-radius: 0;
  font-size: 14px !important;
  font-weight: normal !important;
  height: 35px !important;
  width: 100px;
}
.remove-btn {
  width: 105px;
  font-weight: normal !important;
  line-height: 14px !important;
}
.discharge-btn {
  line-height: 14px;
  width: 90px;
}
.open-btn {
  font-size: 14px !important;
  font-weight: normal !important;
  height: 35px !important;
  width: 100px;
}
.mhr-actions {
  margin: auto;
  width: 80%;
}
</style>
